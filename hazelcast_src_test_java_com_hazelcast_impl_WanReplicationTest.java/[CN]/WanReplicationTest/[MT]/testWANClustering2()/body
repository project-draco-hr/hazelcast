{
  Config c1=new Config();
  Config c2=new Config();
  c1.getGroupConfig().setName("newyork");
  c1.addWanReplicationConfig(new WanReplicationConfig().setName("my-wan").addTargetClusterConfig(new WanTargetClusterConfig().addEndpoint("127.0.0.1:5703").setGroupName("london")));
  c1.getMapConfig("default").setWanReplicationRef(new WanReplicationRef().setName("my-wan").setMergePolicy(PassThroughMergePolicy.NAME));
  c2.getGroupConfig().setName("london");
  c2.addWanReplicationConfig(new WanReplicationConfig().setName("my-wan").addTargetClusterConfig(new WanTargetClusterConfig().addEndpoint("127.0.0.1:5701").setGroupName("newyork")));
  c2.getMapConfig("default").setWanReplicationRef(new WanReplicationRef().setName("my-wan").setMergePolicy(PassThroughMergePolicy.NAME));
  HazelcastInstance h10=Hazelcast.newHazelcastInstance(c1);
  HazelcastInstance h11=Hazelcast.newHazelcastInstance(c1);
  int size=1000;
  for (int i=0; i < size; i++) {
    h11.getMap("default").put(i,"value" + i);
  }
  HazelcastInstance h20=Hazelcast.newHazelcastInstance(c2);
  HazelcastInstance h21=Hazelcast.newHazelcastInstance(c2);
  HazelcastInstance h12=Hazelcast.newHazelcastInstance(c1);
  MergeLatch mergeLatch1=new MergeLatch(size);
  getConcurrentMapManager(h10).addWanMergeListener(mergeLatch1);
  getConcurrentMapManager(h11).addWanMergeListener(mergeLatch1);
  getConcurrentMapManager(h12).addWanMergeListener(mergeLatch1);
  MergeLatch mergeLatch2=new MergeLatch(size);
  getConcurrentMapManager(h20).addWanMergeListener(mergeLatch2);
  getConcurrentMapManager(h21).addWanMergeListener(mergeLatch2);
  assertTrue(mergeLatch2.await(30,TimeUnit.SECONDS));
  Thread.sleep(1000);
  assertEquals(size,mergeLatch2.totalOperations());
  assertEquals(0,mergeLatch1.totalOperations());
  assertEquals(size,h10.getMap("default").size());
  assertEquals(size,h20.getMap("default").size());
  assertEquals(size,h12.getMap("default").size());
  assertEquals(size,h11.getMap("default").size());
  assertEquals(size,h21.getMap("default").size());
  mergeLatch2.reset();
  for (int i=0; i < size; i++) {
    h21.getMap("default").put(size + i,"value" + (size + i));
  }
  assertTrue(mergeLatch1.await(30,TimeUnit.SECONDS));
  Thread.sleep(1000);
  assertEquals(size,mergeLatch1.totalOperations());
  assertEquals(0,mergeLatch2.totalOperations());
  assertEquals(2 * size,h10.getMap("default").size());
  assertEquals(2 * size,h20.getMap("default").size());
  assertEquals(2 * size,h12.getMap("default").size());
  assertEquals(2 * size,h11.getMap("default").size());
  assertEquals(2 * size,h21.getMap("default").size());
  mergeLatch1.reset(size / 2);
  mergeLatch2.reset(size / 2);
  for (int i=0; i < size / 2; i++) {
    h10.getMap("default").remove(i);
    h21.getMap("default").remove(size + i);
  }
  assertTrue(mergeLatch1.await(30,TimeUnit.SECONDS));
  assertTrue(mergeLatch2.await(30,TimeUnit.SECONDS));
  Thread.sleep(1000);
  assertEquals(size / 2,mergeLatch1.totalOperations());
  assertEquals(size / 2,mergeLatch2.totalOperations());
  assertEquals(size,h10.getMap("default").size());
  assertEquals(size,h20.getMap("default").size());
  assertEquals(size,h12.getMap("default").size());
  assertEquals(size,h11.getMap("default").size());
  assertEquals(size,h21.getMap("default").size());
}
