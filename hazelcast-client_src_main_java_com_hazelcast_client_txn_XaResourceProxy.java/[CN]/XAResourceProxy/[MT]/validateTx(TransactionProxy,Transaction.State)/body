{
  if (tx == null) {
    final XAException xaException=new XAException(XAException.XAER_NOTA);
    logger.severe("Transaction is not available!!!",xaException);
    throw xaException;
  }
  final Transaction.State txState=tx.getState();
switch (state) {
case ACTIVE:
    if (txState != ACTIVE) {
      final XAException xaException=new XAException(XAException.XAER_NOTA);
      logger.severe("Transaction is not active!!! state: " + txState,xaException);
      throw xaException;
    }
  break;
case PREPARED:
if (txState != Transaction.State.PREPARED) {
  final XAException xaException=new XAException(XAException.XAER_INVAL);
  logger.severe("Transaction is not prepared!!! state: " + txState,xaException);
  throw xaException;
}
break;
default :
break;
}
}
