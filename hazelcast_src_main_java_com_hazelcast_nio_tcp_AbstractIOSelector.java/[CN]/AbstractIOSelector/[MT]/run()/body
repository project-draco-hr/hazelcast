{
  try {
    while (running) {
      processSelectionQueue();
      if (!running || isInterrupted()) {
        if (logger.isFinestEnabled()) {
          logger.finest(getName() + " is interrupted!");
        }
        running=false;
        return;
      }
      try {
        int selectedKeyCount=selector.select(waitTime);
        if (selectedKeyCount == 0) {
          continue;
        }
      }
 catch (      Throwable e) {
        handleSelectFailure(e);
        continue;
      }
      handleSelectionKeys();
    }
  }
 catch (  OutOfMemoryError e) {
    oomeHandler.handle(e);
  }
catch (  Throwable e) {
    logger.warning("Unhandled exception in " + getName(),e);
  }
 finally {
    try {
      if (logger.isFinestEnabled()) {
        logger.finest("Closing selector " + getName());
      }
      selector.close();
    }
 catch (    final Exception e) {
      logger.finest("Exception while closing selector",e);
    }
  }
}
