{
  lock.lock();
  try {
    Map<Address,MemberImpl> currentMemberMap=membersMapRef.get();
    if (!shouldProcessMemberUpdate(currentMemberMap,members)) {
      return;
    }
    String scopeId=thisAddress.getScopeId();
    Collection<MemberImpl> newMembers=new LinkedList<MemberImpl>();
    MemberImpl[] updatedMembers=new MemberImpl[members.size()];
    int memberIndex=0;
    for (    MemberInfo memberInfo : members) {
      MemberImpl member=currentMemberMap.get(memberInfo.getAddress());
      if (member == null) {
        member=createMember(memberInfo,scopeId);
        newMembers.add(member);
        long now=Clock.currentTimeMillis();
        onHeartbeat(member,now);
        masterConfirmationTimes.put(member,now);
        membersRemovedWhileFrozen.remove(member.getAddress());
      }
      updatedMembers[memberIndex++]=member;
    }
    setMembers(updatedMembers);
    sendMembershipEvents(currentMemberMap.values(),newMembers);
    joinReset();
    heartBeater();
    node.setJoined();
    logger.info(membersString());
  }
  finally {
    lock.unlock();
  }
}
