{
  if (req.key == null || req.key.size() == 0) {
    throw new RuntimeException("Backup key size cannot be zero! " + req.key);
  }
  if (req.operation == CONCURRENT_MAP_BACKUP_PUT) {
    Record rec=toRecord(req);
    rec.setActive();
    if (rec.getVersion() == 0) {
      rec.setVersion(req.version);
    }
    if (req.indexes != null) {
      if (req.indexTypes == null) {
        throw new RuntimeException("index types cannot be null!");
      }
      if (req.indexes.length != req.indexTypes.length) {
        throw new RuntimeException("index and type lengths do not match");
      }
      rec.setIndexes(req.indexes,req.indexTypes);
      if (indexTypes == null) {
        indexTypes=req.indexTypes;
      }
 else {
        if (indexTypes.length != req.indexTypes.length) {
          throw new RuntimeException("Index types do not match.");
        }
      }
    }
  }
 else   if (req.operation == CONCURRENT_MAP_BACKUP_REMOVE) {
    Record record=getRecord(req.key);
    if (record != null) {
      if (record.getCopyCount() > 0) {
        record.decrementCopyCount();
      }
      record.setValue(null);
      markAsRemoved(record);
    }
  }
 else   if (req.operation == CONCURRENT_MAP_BACKUP_LOCK) {
    Record rec=toRecord(req);
    if (rec.getVersion() == 0) {
      rec.setVersion(req.version);
    }
  }
 else   if (req.operation == CONCURRENT_MAP_BACKUP_ADD) {
    add(req);
  }
 else   if (req.operation == CONCURRENT_MAP_BACKUP_REMOVE_MULTI) {
    Record record=getRecord(req.key);
    if (record != null) {
      if (req.value == null) {
        markAsRemoved(record);
      }
 else {
        if (record.containsValue(req.value)) {
          if (record.getMultiValues() != null) {
            Iterator<Data> itValues=record.getMultiValues().iterator();
            while (itValues.hasNext()) {
              Data value=itValues.next();
              if (req.value.equals(value)) {
                itValues.remove();
              }
            }
          }
        }
      }
      if (record.isRemovable()) {
        markAsRemoved(record);
      }
    }
  }
 else {
    logger.log(Level.SEVERE,"Unknown backup operation " + req.operation);
  }
}
