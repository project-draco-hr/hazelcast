{
  if (req.key == null || req.key.size() == 0) {
    throw new RuntimeException("Backup key size cannot be zero! " + req.key);
  }
  if (req.operation == CONCURRENT_MAP_BACKUP_PUT) {
    Record record=toRecord(req);
    markAsActive(record);
    record.setVersion(req.version);
    if (req.indexes != null) {
      if (req.indexTypes == null) {
        throw new RuntimeException("index types cannot be null!");
      }
      if (req.indexes.length != req.indexTypes.length) {
        throw new RuntimeException("index and type lengths do not match");
      }
      record.setIndexes(req.indexes,req.indexTypes);
    }
    if (req.ttl > 0 && req.ttl < Long.MAX_VALUE) {
      record.setTTL(req.ttl);
      ttlPerRecord=true;
    }
  }
 else   if (req.operation == CONCURRENT_MAP_BACKUP_REMOVE) {
    Record record=toRecord(req);
    if (record.isActive()) {
      markAsEvicted(record);
    }
    record.setVersion(req.version);
  }
 else   if (req.operation == CONCURRENT_MAP_BACKUP_LOCK) {
    if (req.lockCount == 0) {
      Record record=getRecord(req);
      if (record != null) {
        record.setLock(null);
        if (record.valueCount() == 0) {
          markAsEvicted(record);
        }
      }
    }
 else {
      Record record=toRecord(req);
      if (record.getVersion() == 0) {
        record.setVersion(req.version);
      }
    }
  }
 else   if (req.operation == CONCURRENT_MAP_BACKUP_ADD) {
    add(req,true);
  }
 else   if (req.operation == CONCURRENT_MAP_BACKUP_REMOVE_MULTI) {
    Record record=getRecord(req);
    if (record != null) {
      if (req.value == null || record.valueCount() == 0) {
        markAsEvicted(record);
      }
 else {
        Collection<ValueHolder> multiValues=record.getMultiValues();
        if (multiValues != null) {
          multiValues.remove(new ValueHolder(req.value));
        }
        if (record.valueCount() == 0) {
          markAsEvicted(record);
        }
      }
    }
  }
 else {
    logger.log(Level.SEVERE,"Unknown backup operation " + req.operation);
  }
}
