{
  Record record=getRecord(req);
  if (record == null) {
    if (isMultiMap()) {
      record=createNewRecord(req.key,null);
      record.setMultiValues(createMultiValuesCollection());
      if (req.value != null) {
        record.getMultiValues().add(new ValueHolder(req.value));
      }
    }
 else {
      record=createNewRecord(req.key,req.value);
    }
    mapRecords.put(req.key,record);
  }
 else {
    if (req.value != null) {
      if (isMultiMap()) {
        if (record.getMultiValues() == null) {
          record.setMultiValues(createMultiValuesCollection());
        }
        record.getMultiValues().add(new ValueHolder(req.value));
      }
 else {
        record.setValue(req.value);
      }
    }
  }
  record.setIndexes(req.indexes,req.indexTypes);
  if (req.lockCount > 0) {
    DistributedLock lock=new DistributedLock(req.lockAddress,req.lockThreadId,req.lockCount);
    record.setLock(lock);
  }
  return record;
}
