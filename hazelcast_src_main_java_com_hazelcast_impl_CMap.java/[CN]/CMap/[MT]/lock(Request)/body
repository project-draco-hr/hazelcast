{
  Data reqValue=request.value;
  Record rec=concurrentMapManager.ensureRecord(request);
  if (request.operation == CONCURRENT_MAP_TRY_LOCK_AND_GET) {
    if (reqValue == null) {
      request.value=rec.getValueData();
      if (rec.getMultiValues() != null) {
        Values values=new Values(rec.getMultiValues());
        request.value=toData(values);
      }
    }
  }
  DistributedLock lock=rec.getLock();
  Long response=(lock == null || !lock.isLocked()) ? 0L : 1L;
  final boolean locked=rec.lock(request.lockThreadId,request.lockAddress);
  if (!locked) {
    response=-1L;
    Throwable t=new IllegalStateException("Something is wrong! Lock cannot be acquired! " + request + " -> "+ lock);
    logger.log(Level.SEVERE,t.getMessage(),t);
  }
  rec.incrementVersion();
  request.version=rec.getVersion();
  request.lockCount=rec.getLockCount();
  markAsActive(rec);
  request.response=response;
}
