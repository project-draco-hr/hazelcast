{
  Data dataOldValue=null;
  Data dataValue=null;
  Object v=value;
  try {
switch (cacheConfig.getInMemoryFormat()) {
case BINARY:
      v=toData(value);
    dataValue=(Data)v;
  dataOldValue=toData(record);
break;
case OBJECT:
if (value instanceof Data) {
v=dataToValue((Data)value);
dataValue=(Data)value;
}
 else {
dataValue=valueToData(value);
}
dataOldValue=toData(record);
break;
case NATIVE:
v=toData(value);
dataValue=(Data)v;
dataOldValue=toData(record);
break;
default :
throw new IllegalArgumentException("Invalid storage format: " + cacheConfig.getInMemoryFormat());
}
Data eventDataKey=toEventData(key);
Data eventDataValue=toEventData(dataValue);
Data eventDataOldValue=toEventData(dataOldValue);
onBeforeUpdateRecord(key,record,value,dataOldValue);
record.setValue(v);
onAfterUpdateRecord(key,record,value,dataOldValue);
updateHasExpiringEntry(record);
if (isEventsEnabled) {
publishEvent(CacheEventType.UPDATED,eventDataKey,eventDataOldValue,eventDataValue,true,completionId);
}
return record;
}
 catch (Throwable error) {
onUpdateRecordError(key,record,value,dataValue,dataOldValue,error);
throw ExceptionUtil.rethrow(error);
}
}
