{
  expiryPolicy=getExpiryPolicy(expiryPolicy);
  final long now=Clock.currentTimeMillis();
  final long start=isStatisticsEnabled() ? System.nanoTime() : 0;
  boolean isOnNewPut=false;
  boolean isSaveSucceed=false;
  Object oldValue=null;
  R record=records.get(key);
  boolean isExpired=processExpiredEntry(key,record,now);
  try {
    if (record == null || isExpired) {
      isOnNewPut=true;
      onBeforeGetAndPut(key,value,expiryPolicy,caller,getValue,disableWriteThrough,record,oldValue,isExpired,isOnNewPut);
      record=createRecordWithExpiry(key,value,expiryPolicy,now,disableWriteThrough);
      isSaveSucceed=record != null;
    }
 else {
      if (getValue) {
        oldValue=toValue(record);
      }
      onBeforeGetAndPut(key,value,expiryPolicy,caller,getValue,disableWriteThrough,record,oldValue,isExpired,isOnNewPut);
      isSaveSucceed=updateRecordWithExpiry(key,value,record,expiryPolicy,now,disableWriteThrough);
    }
    updateGetAndPutStat(isSaveSucceed,getValue,oldValue == null,start);
    onAfterGetAndPut(key,value,expiryPolicy,caller,getValue,disableWriteThrough,record,oldValue,isExpired,isOnNewPut,isSaveSucceed);
    return oldValue;
  }
 catch (  Throwable error) {
    error.printStackTrace();
    onGetAndPutError(key,value,expiryPolicy,caller,getValue,disableWriteThrough,record,oldValue,isOnNewPut,error);
    throw new RuntimeException(error);
  }
}
