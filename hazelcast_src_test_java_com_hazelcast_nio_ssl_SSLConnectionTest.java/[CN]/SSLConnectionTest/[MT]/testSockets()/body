{
  ServerSocketChannel serverSocketChannel=null;
  Socket socket=null;
  final ExecutorService ex=Executors.newCachedThreadPool();
  try {
    final int count=250;
    serverSocketChannel=ServerSocketChannel.open();
    ex.execute(new ServerSocketChannelProcessor(serverSocketChannel,count,ex));
    SSLContext clientContext=createClientSslContext();
    javax.net.ssl.SSLSocketFactory socketFactory=clientContext.getSocketFactory();
    socket=socketFactory.createSocket();
    socket.connect(new InetSocketAddress(PORT));
    DataOutputStream out=new DataOutputStream(socket.getOutputStream());
    DataInputStream in=new DataInputStream(socket.getInputStream());
    for (int i=0; i < count; i++) {
      out.writeInt(i);
      out.flush();
      int k=in.readInt();
      assertEquals(i * 2 + 1,k);
    }
  }
  finally {
    ex.shutdownNow();
    if (socket != null) {
      try {
        socket.close();
      }
 catch (      IOException e) {
      }
    }
    IOUtil.closeResource(serverSocketChannel);
  }
}
