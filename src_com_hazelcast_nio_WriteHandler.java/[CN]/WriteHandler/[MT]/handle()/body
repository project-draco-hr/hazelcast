{
  if (!connection.live())   return;
  try {
    bbOut.clear();
    copyLoop:     while (bbOut.position() < (32 * 1024)) {
      Invocation inv=(Invocation)writeHandlerQueue.poll();
      if (inv == null)       break copyLoop;
      inv.write(bbOut);
      doPostWrite(inv);
    }
    if (bbOut.position() == 0)     return;
    bbOut.flip();
    int remaining=bbOut.remaining();
    int loopCount=0;
    while (remaining > 0) {
      try {
        int written=socketChannel.write(bbOut);
        remaining-=written;
        loopCount++;
        if (DEBUG) {
          if (loopCount > 1) {
            System.out.println("loopcount " + loopCount);
          }
        }
      }
 catch (      Exception e) {
        handleSocketException(e);
      }
    }
  }
 catch (  Throwable t) {
    System.out.println("Fatal Error: WriteHandler " + t);
  }
 finally {
    if (hasMore()) {
      registerWrite();
    }
 else {
      alreadyRegistered.set(false);
    }
  }
}
