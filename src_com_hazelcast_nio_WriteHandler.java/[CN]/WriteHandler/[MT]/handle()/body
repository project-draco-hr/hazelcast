{
  if (lastPacket == null && writeQueue.size() == 0) {
    ready=true;
    return;
  }
  if (!connection.live())   return;
  try {
    loop:     while (socketBB.hasRemaining()) {
      if (lastPacket == null) {
        lastPacket=(Packet)writeQueue.poll();
      }
      if (lastPacket != null) {
        boolean packetDone=lastPacket.writeToSocketBuffer(socketBB);
        if (packetDone) {
          lastPacket.returnToContainer();
          lastPacket=null;
        }
      }
 else       break loop;
    }
    socketBB.flip();
    try {
      socketChannel.write(socketBB);
    }
 catch (    final Exception e) {
      if (lastPacket != null) {
        lastPacket.returnToContainer();
        lastPacket=null;
      }
      handleSocketException(e);
      return;
    }
    if (socketBB.hasRemaining()) {
      socketBB.compact();
    }
 else {
      socketBB.clear();
    }
  }
 catch (  final Throwable t) {
    logger.log(Level.SEVERE,"Fatal Error at WriteHandler for endPoint: " + connection.getEndPoint(),t);
  }
 finally {
    ready=false;
    registerWrite();
  }
}
