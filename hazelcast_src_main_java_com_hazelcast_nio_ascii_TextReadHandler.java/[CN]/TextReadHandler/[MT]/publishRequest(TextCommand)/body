{
  if (!connectionTypeSet) {
    if (command instanceof HttpCommand) {
      boolean isMancenterRequest=((HttpCommand)command).getURI().startsWith(HttpCommandProcessor.URI_MANCENTER_CHANGE_URL);
      if (!restEnabled && !isMancenterRequest) {
        connection.close();
        return;
      }
      connection.setType(ConnectionType.REST_CLIENT);
    }
 else {
      if (!memcacheEnabled) {
        connection.close();
        return;
      }
      connection.setType(ConnectionType.MEMCACHE_CLIENT);
    }
    connectionTypeSet=true;
  }
  long requestId=(command.shouldReply()) ? requestIdGen++ : -1;
  command.init(this,requestId);
  textCommandService.processRequest(command);
}
