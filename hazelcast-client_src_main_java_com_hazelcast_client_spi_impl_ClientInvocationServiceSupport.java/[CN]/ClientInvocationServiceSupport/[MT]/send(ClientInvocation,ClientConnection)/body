{
  if (isShutdown) {
    throw new HazelcastClientNotActiveException("Client is shut down");
  }
  registerInvocation(invocation);
  final SerializationService ss=client.getSerializationService();
  final byte[] bytes=ss.toBytes(invocation.getRequest());
  Packet packet=new Packet(bytes,invocation.getPartitionId());
  if (!isAllowedToSendRequest(connection,invocation.getRequest()) || !connection.write(packet)) {
    int callId=invocation.getRequest().getCallId();
    ClientInvocation clientInvocation=deRegisterCallId(callId);
    if (clientInvocation != null) {
      throw new IOException("Packet not send to " + connection.getRemoteEndpoint());
    }
 else {
      if (logger.isFinestEnabled()) {
        logger.finest("Invocation not found to deregister for call id " + callId);
      }
    }
  }
  invocation.setSendConnection(connection);
}
