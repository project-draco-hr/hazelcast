{
  final int partitionCount=currentState.length;
  final List<MigrationRequestOperation> partitionMigrationTasks=new LinkedList<MigrationRequestOperation>();
  for (int partitionId=0; partitionId < partitionCount; partitionId++) {
    PartitionInfo currentPartition=currentState[partitionId];
    PartitionInfo newPartition=newState[partitionId];
    for (int replicaIndex=0; replicaIndex < PartitionInfo.MAX_REPLICA_COUNT; replicaIndex++) {
      Address currentOwner=currentPartition.getReplicaAddress(replicaIndex);
      Address newOwner=newPartition.getReplicaAddress(replicaIndex);
      MigrationRequestOperation migrationRequestTask=null;
      if (currentOwner != null && newOwner != null && !currentOwner.equals(newOwner)) {
        migrationRequestTask=new MigrationRequestOperation(partitionId,currentOwner,newOwner,replicaIndex,true);
      }
 else       if (currentOwner == null && newOwner != null) {
        currentOwner=currentPartition.getOwner();
        boolean selfCopy=false;
        ListIterator<MigrationRequestOperation> iter=partitionMigrationTasks.listIterator(partitionMigrationTasks.size());
        while (iter.hasPrevious()) {
          MigrationRequestOperation task=iter.previous();
          if (task.isMigration() && newOwner.equals(task.getFromAddress())) {
            selfCopy=true;
            task.setSelfCopyReplicaIndex(replicaIndex);
            break;
          }
        }
        if (!selfCopy) {
          migrationRequestTask=new MigrationRequestOperation(partitionId,currentOwner,newOwner,replicaIndex,false);
        }
      }
 else       if (currentOwner != null && newOwner == null) {
        immediateTasksList.add(new MigrationRequestOperation(partitionId,currentOwner,null,replicaIndex,false));
      }
      if (migrationRequestTask != null) {
        partitionMigrationTasks.add(migrationRequestTask);
        if (replicaIndex == 0 && currentOwner == null) {
          lostPartitionTasksList.add(migrationRequestTask);
        }
 else         if (replicaIndex == 0 && currentOwner != null && currentOwner.equals(newPartition.getReplicaAddress(1))) {
          immediateTasksList.add(migrationRequestTask);
        }
 else         if (replicaIndex == 1 && currentPartition.getReplicaAddress(1) == null) {
          immediateTasksList.add(migrationRequestTask);
        }
 else {
          scheduledTasksList.add(migrationRequestTask);
        }
      }
    }
    partitionMigrationTasks.clear();
  }
  arrangeScheduledTasks(scheduledTasksList);
}
