{
  for (  HazelcastInstance instance : instances) {
    final Node survivingNode=getNode(instance);
    final Address survivingNodeAddress=survivingNode.getThisAddress();
    for (    InternalPartition partition : survivingNode.getPartitionService().getPartitions()) {
      if (partition.isOwnerOrBackup(survivingNodeAddress)) {
        final List<Address> replicas=new ArrayList<Address>();
        for (int replicaIndex=0; replicaIndex < getNodeCount(); replicaIndex++) {
          replicas.add(partition.getReplicaAddress(replicaIndex));
        }
        partitionTables.put(partition.getPartitionId(),replicas);
      }
    }
    for (    InternalPartition partition : survivingNode.getPartitionService().getPartitions()) {
      if (partition.isOwnerOrBackup(survivingNodeAddress)) {
        for (int replicaIndex=0; replicaIndex < getNodeCount(); replicaIndex++) {
          if (survivingNodeAddress.equals(partition.getReplicaAddress(replicaIndex))) {
            final Integer replicaIndexOfOtherInstance=survivingPartitions.get(partition.getPartitionId());
            if (replicaIndexOfOtherInstance != null) {
              survivingPartitions.put(partition.getPartitionId(),Math.min(replicaIndex,replicaIndexOfOtherInstance));
            }
 else {
              survivingPartitions.put(partition.getPartitionId(),replicaIndex);
            }
            break;
          }
        }
      }
    }
  }
}
