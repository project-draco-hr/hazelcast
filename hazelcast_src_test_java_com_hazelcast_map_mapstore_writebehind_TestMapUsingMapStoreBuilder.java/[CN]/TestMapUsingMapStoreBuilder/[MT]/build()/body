{
  if (backupCount != 0 && backupCount > nodeCount - 1) {
    throw new IllegalArgumentException("backupCount > nodeCount - 1");
  }
  final MapStoreConfig mapStoreConfig=new MapStoreConfig();
  mapStoreConfig.setImplementation(mapStore).setWriteDelaySeconds(writeDelaySeconds).setWriteBatchSize(writeBatchSize);
  final Config config=new Config();
  config.getMapConfig(mapName).setBackupCount(backupCount).setMapStoreConfig(mapStoreConfig).setInMemoryFormat(inMemoryFormat);
  config.setProperty(GroupProperties.PROP_PARTITION_COUNT,String.valueOf(partitionCount));
  final TestHazelcastInstanceFactory instanceFactory=new TestHazelcastInstanceFactory(nodeCount);
  nodes=instanceFactory.newInstances(config);
  return nodes[0].getMap(mapName);
}
