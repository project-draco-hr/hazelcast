{
synchronized (joinerLock) {
    Address master;
    final ClusterJoinManager clusterJoinManager=node.clusterService.getClusterJoinManager();
    for (int i=0; !node.joined() && node.isRunning() && i < 2000; i++) {
      try {
        master=node.getMasterAddress();
        if (master == null) {
          master=findCurrentMasterAddress();
          node.setMasterAddress(master);
        }
        Assert.assertNotNull(master);
        if (master.equals(node.getThisAddress())) {
          node.setJoined();
          node.setAsMaster();
          break;
        }
        clusterJoinManager.sendJoinRequest(master,true);
        Thread.sleep(50);
      }
 catch (      InterruptedException e) {
        e.printStackTrace();
        break;
      }
    }
    if (!node.joined()) {
      logger.severe("Node[" + node.getThisAddress() + "] should have been joined to "+ node.getMasterAddress());
      node.shutdown(true);
    }
  }
}
