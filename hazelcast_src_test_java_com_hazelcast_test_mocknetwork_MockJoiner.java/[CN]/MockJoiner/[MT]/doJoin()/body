{
synchronized (joinerLock) {
    ClusterJoinManager clusterJoinManager=node.clusterService.getClusterJoinManager();
    long joinStartTime=Clock.currentTimeMillis();
    long maxJoinMillis=getMaxJoinMillis();
    while (node.isRunning() && !node.joined() && (Clock.currentTimeMillis() - joinStartTime < maxJoinMillis)) {
      try {
        if (masterAddress == null) {
          lookupMasterAddress();
        }
        if (node.getThisAddress().equals(masterAddress)) {
          logger.fine("This node is found as master, no need to join.");
          node.setJoined();
          node.setAsMaster();
          break;
        }
        if (masterAddress != null) {
          logger.fine("Sending join request to master " + masterAddress);
          node.setMasterAddress(masterAddress);
          if (!clusterJoinManager.sendJoinRequest(masterAddress,true)) {
            logger.fine("Could not send join request to " + masterAddress);
            masterAddress=null;
          }
        }
        Thread.sleep(500);
      }
 catch (      InterruptedException e) {
        e.printStackTrace();
        break;
      }
    }
    if (!node.joined()) {
      logger.severe("Node[" + node.getThisAddress() + "] should have been joined to "+ node.getMasterAddress());
      node.shutdown(true);
    }
  }
}
