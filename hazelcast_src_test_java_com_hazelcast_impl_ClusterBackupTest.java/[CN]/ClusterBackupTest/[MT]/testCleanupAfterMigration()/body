{
  System.setProperty("hazelcast.log.state","true");
  final int size=10000;
  HazelcastInstance h1=Hazelcast.newHazelcastInstance(null);
  IMap map1=h1.getMap("default");
  for (int i=0; i < size; i++) {
    map1.put(i,"value" + i);
  }
  assertEquals(size,map1.size());
  HazelcastInstance h2=Hazelcast.newHazelcastInstance(new Config());
  HazelcastInstance h3=Hazelcast.newHazelcastInstance(new Config());
  IMap map2=h2.getMap("default");
  IMap map3=h3.getMap("default");
  for (int i=0; i < 100; i++) {
    assertEquals(size,map1.size());
    assertEquals(size,map2.size());
    assertEquals(size,map3.size());
  }
  ConcurrentMapManager c1=getConcurrentMapManager(h1);
  ConcurrentMapManager c2=getConcurrentMapManager(h2);
  ConcurrentMapManager c3=getConcurrentMapManager(h3);
  c1.startCleanup(true,true);
  c2.startCleanup(true,true);
  c3.startCleanup(true,true);
  Thread.sleep(1000);
  CMap cmap1=c1.getMap("c:default");
  CMap cmap2=c2.getMap("c:default");
  CMap cmap3=c3.getMap("c:default");
  assertTrue(cmap1.mapRecords.size() <= size);
  assertTrue(cmap2.mapRecords.size() <= size);
  assertTrue(cmap3.mapRecords.size() <= size);
  assertEquals(cmap1.mapRecords.size(),getOwnedAndBackupCount(map1));
  assertEquals(cmap2.mapRecords.size(),getOwnedAndBackupCount(map2));
  assertEquals(cmap3.mapRecords.size(),getOwnedAndBackupCount(map3));
  HazelcastInstance h4=Hazelcast.newHazelcastInstance(new Config());
  IMap map4=h4.getMap("default");
  ConcurrentMapManager c4=getConcurrentMapManager(h4);
  CMap cmap4=c4.getMap("c:default");
  Thread.sleep(1000);
  c1.startCleanup(true,true);
  c2.startCleanup(true,true);
  c3.startCleanup(true,true);
  c4.startCleanup(true,true);
  Thread.sleep(8000);
  assertEquals(cmap1.mapRecords.size(),getOwnedAndBackupCount(map1));
  assertEquals(cmap2.mapRecords.size(),getOwnedAndBackupCount(map2));
  assertEquals(cmap3.mapRecords.size(),getOwnedAndBackupCount(map3));
  assertEquals(cmap4.mapRecords.size(),getOwnedAndBackupCount(map4));
  h4.getLifecycleService().shutdown();
  Thread.sleep(1000);
  c1.startCleanup(true,true);
  c2.startCleanup(true,true);
  c3.startCleanup(true,true);
  Thread.sleep(8000);
  assertEquals(cmap1.mapRecords.size(),getOwnedAndBackupCount(map1));
  assertEquals(cmap2.mapRecords.size(),getOwnedAndBackupCount(map2));
  assertEquals(cmap3.mapRecords.size(),getOwnedAndBackupCount(map3));
  System.setProperty("hazelcast.log.state","false");
}
