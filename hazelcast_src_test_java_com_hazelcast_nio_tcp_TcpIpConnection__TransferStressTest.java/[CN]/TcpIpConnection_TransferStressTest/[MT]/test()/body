{
  TcpIpConnection c=connect(connManagerA,addressB);
  WriteThread thread1=new WriteThread(1,c);
  WriteThread thread2=new WriteThread(2,c);
  logger.info("Starting");
  thread1.start();
  thread2.start();
  sleepAndStop(stop,DURATION_SECONDS);
  logger.info("Done");
  thread1.assertSucceedsEventually();
  thread2.assertSucceedsEventually();
  final long expectedNormalPackets=thread1.normalPackets + thread2.normalPackets + 1;
  final long expectedUrgentPackets=thread1.urgentPackets + thread2.urgentPackets;
  logger.info("expected normal packets: " + expectedNormalPackets);
  logger.info("expected priority packets: " + expectedUrgentPackets);
  final ReadHandler readHandler=((TcpIpConnection)connManagerB.getConnection(addressA)).getReadHandler();
  assertTrueEventually(new AssertTask(){
    @Override public void run() throws Exception {
      assertEquals(expectedNormalPackets,readHandler.getNormalPacketsReadCounter().get());
      assertEquals(expectedUrgentPackets,readHandler.getPriorityPacketsReadCounter().get());
    }
  }
);
}
