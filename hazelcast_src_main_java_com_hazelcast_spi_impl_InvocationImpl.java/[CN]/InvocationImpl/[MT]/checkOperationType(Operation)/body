{
  final Operation parentOp=(Operation)ThreadContext.get().getCurrentOperation();
  boolean allowed=true;
  if (parentOp != null) {
    if (op instanceof BackupOperation && !(parentOp instanceof BackupOperation)) {
    }
 else     if (parentOp instanceof PartitionLevelOperation) {
      if (op instanceof PartitionLevelOperation && op.getPartitionId() == parentOp.getPartitionId()) {
      }
 else       if (!(op instanceof PartitionAwareOperation)) {
      }
 else {
        allowed=false;
      }
    }
 else     if (parentOp instanceof KeyBasedOperation) {
      if (op instanceof PartitionLevelOperation) {
        allowed=false;
      }
 else       if (op instanceof KeyBasedOperation && ((KeyBasedOperation)parentOp).getKeyHash() == ((KeyBasedOperation)op).getKeyHash() && parentOp.getPartitionId() == op.getPartitionId()) {
      }
 else       if (op instanceof PartitionAwareOperation && op.getPartitionId() == parentOp.getPartitionId()) {
      }
 else       if (!(op instanceof PartitionAwareOperation)) {
      }
 else {
        allowed=false;
      }
    }
 else     if (parentOp instanceof PartitionAwareOperation) {
      if (op instanceof PartitionLevelOperation) {
        allowed=false;
      }
 else       if (op instanceof PartitionAwareOperation && op.getPartitionId() == parentOp.getPartitionId()) {
      }
 else       if (!(op instanceof PartitionAwareOperation)) {
      }
 else {
        allowed=false;
      }
    }
  }
  if (!allowed) {
    throw new HazelcastException("INVOCATION IS NOT ALLOWED! ParentOp: " + parentOp + ", CurrentOp: "+ op);
  }
}
