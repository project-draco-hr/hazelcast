{
  final HazelcastInstance h1=Hazelcast.newHazelcastInstance(new Config());
  final IMap map1=h1.getMap("default");
  final HazelcastInstance h2=Hazelcast.newHazelcastInstance(new Config());
  final IMap map2=h2.getMap("default");
  final HazelcastInstance h3=Hazelcast.newHazelcastInstance(new Config());
  final IMap map3=h3.getMap("default");
  map1.put(1,1);
  migrateKey(1,h1,h2,0);
  migrateKey(1,h1,h3,1);
  final CountDownLatch latchShutdown=new CountDownLatch(1);
  final CountDownLatch latchLock=new CountDownLatch(1);
  Assert.assertTrue(map2.tryLock(1));
  new Thread(new Runnable(){
    public void run(){
      try {
        map3.lock(1);
        latchShutdown.countDown();
        assertTrue(latchLock.await(10,TimeUnit.SECONDS));
        map3.unlock(1);
      }
 catch (      Throwable e) {
        fail(e.getMessage());
      }
    }
  }
).start();
  Thread.sleep(2000);
  h2.getLifecycleService().shutdown();
  assertTrue(latchShutdown.await(10,TimeUnit.SECONDS));
  Assert.assertFalse(map1.tryLock(1));
  latchLock.countDown();
  Assert.assertTrue(map1.tryLock(1,10,TimeUnit.SECONDS));
}
