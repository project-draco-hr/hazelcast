{
  lastHandle=System.currentTimeMillis();
  if (socketWriter == null) {
    setProtocol("HZC");
  }
  if (lastWritable == null) {
    lastWritable=poll();
    if (lastWritable == null && socketBB.position() == 0) {
      ready=true;
      return;
    }
  }
  if (!connection.live())   return;
  try {
    while (socketBB.hasRemaining()) {
      if (lastWritable == null) {
        lastWritable=poll();
      }
      if (lastWritable != null) {
        boolean complete=socketWriter.write(lastWritable,socketBB);
        if (complete) {
          if (lastWritable instanceof Packet) {
            Packet packet=(Packet)lastWritable;
            connection.releasePacket(packet);
            if (systemLogService.shouldTrace()) {
              systemLogService.trace(packet,new SystemArgsLog("WrittenOut ",connection.getEndPoint(),packet.operation));
            }
          }
          lastWritable=null;
        }
 else {
          if (socketBB.hasRemaining()) {
            break;
          }
        }
      }
 else {
        break;
      }
    }
    if (socketBB.position() > 0) {
      socketBB.flip();
      try {
        socketChannel.write(socketBB);
      }
 catch (      Exception e) {
        lastWritable=null;
        handleSocketException(e);
        return;
      }
      if (socketBB.hasRemaining()) {
        socketBB.compact();
      }
 else {
        socketBB.clear();
      }
    }
  }
 catch (  Throwable t) {
    logger.log(Level.SEVERE,"Fatal Error at WriteHandler for endPoint: " + connection.getEndPoint(),t);
    connection.getSystemLogService().logConnection("Fatal Error at WriteHandler for endPoint " + "[" + connection.getEndPoint() + "]: "+ t.getMessage());
  }
 finally {
    ready=false;
    registerWrite();
  }
}
