{
  if (cipherBuffer.position() > 0 && socketBB.hasRemaining()) {
    cipherBuffer.flip();
    copyToDirectBuffer(cipherBuffer,socketBB);
    if (cipherBuffer.hasRemaining()) {
      cipherBuffer.compact();
    }
 else {
      cipherBuffer.clear();
    }
  }
  packet.totalWritten+=encryptAndWriteToSocket(packet.bbSizes);
  packet.totalWritten+=encryptAndWriteToSocket(packet.bbHeader);
  if (packet.getKey() != null && packet.getKey().size() > 0 && socketBB.hasRemaining()) {
    packet.totalWritten+=encryptAndWriteToSocket(packet.getKey().buffer);
  }
  if (packet.getValue() != null && packet.getValue().size() > 0 && socketBB.hasRemaining()) {
    packet.totalWritten+=encryptAndWriteToSocket(packet.getValue().buffer);
  }
  return packet.totalWritten >= packet.totalSize;
}
