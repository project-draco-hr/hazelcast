{
  try {
    if (roleName != null && (identity != null || credential != null)) {
      throw new InvalidConfigurationException("IAM role is configured, identity " + "or credential propery is not allowed.");
    }
    if (cloudProvider.equals(AWS_EC2) && roleName != null) {
      Supplier<Credentials> credentialsSupplier=new Supplier<Credentials>(){
        @Override public Credentials get(){
          return new IAMRoleCredentialSupplierBuilder().withRoleName(roleName).build();
        }
      }
;
      return ContextBuilder.newBuilder(cloudProvider).credentialsSupplier(credentialsSupplier);
    }
 else {
      checkNotNull(identity,"Cloud provider identity is not set");
      checkNotNull(credential,"Cloud provider credential is not set");
      return ContextBuilder.newBuilder(cloudProvider).credentials(identity,credential);
    }
  }
 catch (  NoSuchElementException e) {
    throw new InvalidConfigurationException("Unrecognized cloud-provider [" + cloudProvider + "]");
  }
}
