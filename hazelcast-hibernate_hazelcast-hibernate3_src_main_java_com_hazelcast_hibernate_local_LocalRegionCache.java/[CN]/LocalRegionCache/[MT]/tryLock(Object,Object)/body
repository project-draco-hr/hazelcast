{
  final Value value=cache.get(key);
  if (value == null) {
    if (cache.putIfAbsent(key,new Value(version,null,LOCK_SUCCESS,Clock.currentTimeMillis())) == null) {
      return LOCK_SUCCESS;
    }
 else {
      return LOCK_FAILURE;
    }
  }
 else {
    if (version == null || versionComparator.compare(version,value.getVersion()) >= 0) {
      if (cache.replace(key,value,value.createLockedValue(LOCK_SUCCESS))) {
        return LOCK_SUCCESS;
      }
 else {
        return LOCK_FAILURE;
      }
    }
 else {
      return LOCK_FAILURE;
    }
  }
}
