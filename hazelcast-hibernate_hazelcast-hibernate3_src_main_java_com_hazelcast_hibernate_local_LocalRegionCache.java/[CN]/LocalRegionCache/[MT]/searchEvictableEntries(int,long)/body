{
  final Iterator<Entry<Object,Value>> iterator=cache.entrySet().iterator();
  SortedSet<EvictionEntry> entries=null;
  final long now=Clock.currentTimeMillis();
  while (iterator.hasNext()) {
    final Entry<Object,Value> e=iterator.next();
    final Object k=e.getKey();
    final Value v=e.getValue();
    if (v.getLock() == LOCK_SUCCESS) {
      continue;
    }
    if (v.getCreationTime() + timeToLive < now) {
      iterator.remove();
    }
 else     if (maxSize > 0 && maxSize != Integer.MAX_VALUE) {
      if (entries == null) {
        entries=new TreeSet<EvictionEntry>();
      }
      entries.add(new EvictionEntry(k,v));
    }
  }
  return entries;
}
