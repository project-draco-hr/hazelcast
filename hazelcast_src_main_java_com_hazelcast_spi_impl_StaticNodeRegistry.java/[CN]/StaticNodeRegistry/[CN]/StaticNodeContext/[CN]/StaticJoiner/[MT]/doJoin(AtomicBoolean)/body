{
  Address master=null;
  for (  Address address : addresses) {
    final NodeEngineImpl nodeEngine=nodes.get(address);
    if (nodeEngine != null && nodeEngine.getNode().isActive()) {
      master=address;
      break;
    }
  }
  node.setMasterAddress(master);
  if (node.getMasterAddress().equals(node.getThisAddress())) {
    node.setJoined();
  }
 else {
    for (int i=0; !node.joined() && i < 100; i++) {
      try {
        node.clusterService.sendJoinRequest(node.getMasterAddress(),true);
        Thread.sleep(10);
      }
 catch (      InterruptedException e) {
        e.printStackTrace();
      }
    }
    if (!node.joined()) {
      throw new AssertionError("Node[" + thisAddress + "] should have been joined to "+ node.getMasterAddress());
    }
  }
}
