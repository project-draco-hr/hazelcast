{
  if (config == null) {
    config=new XmlConfigBuilder().build();
  }
  String name=instanceName;
  if (name == null || name.trim().length() == 0) {
    name=createInstanceName(config);
  }
  InstanceFuture future=new InstanceFuture();
  if (INSTANCE_MAP.putIfAbsent(name,future) != null) {
    throw new DuplicateInstanceNameException("HazelcastInstance with name '" + name + "' already exists!");
  }
  try {
    HazelcastInstanceProxy hz=constructHazelcastInstance(config,name,nodeContext);
    future.set(hz);
    return hz;
  }
 catch (  Throwable t) {
    INSTANCE_MAP.remove(name,future);
    future.setFailure(t);
    throw ExceptionUtil.rethrow(t);
  }
}
