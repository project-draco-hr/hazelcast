{
  final Operation currentOp=(Operation)ThreadContext.get().getCurrentOperation();
  final Operation op=inv.getOperation();
  final Address target=inv.getTarget();
  final int partitionId=inv.getPartitionId();
  final int replicaIndex=inv.getReplicaIndex();
  final String serviceName=inv.getServiceName();
  op.setNodeService(this).setServiceName(serviceName).setCaller(getThisAddress()).setPartitionId(partitionId).setReplicaIndex(replicaIndex);
  checkInvocation(inv);
  if (getThisAddress().equals(target)) {
    ResponseHandlerFactory.setLocalResponseHandler(inv);
    executeOperation(op);
  }
 else {
    Call call=new Call(target,inv);
    long callId=registerCall(call);
    op.setCallId(callId);
    boolean sent=send(op,partitionId,target);
    if (!sent) {
      inv.setResult(new RetryableException(new IOException("Packet not sent!")));
    }
  }
}
