{
  final ThreadContext threadContext=ThreadContext.get();
  final Object parentOperation=threadContext.getCurrentOperation();
  threadContext.setCurrentOperation(op);
  try {
    op.beforeRun();
    if (op instanceof WaitSupport) {
      WaitSupport so=(WaitSupport)op;
      if (so.shouldWait()) {
        waitNotifyService.wait(so);
        return;
      }
    }
    op.run();
    if (op instanceof BackupAwareOperation) {
      handleBackupAndSendResponse(op);
    }
 else {
      sendResponse(op,op.getResponse());
    }
    op.afterRun();
    if (op instanceof Notifier) {
      waitNotifyService.notify((Notifier)op);
    }
  }
 catch (  Throwable e) {
    handleOperationError(op,e);
  }
 finally {
    threadContext.setCurrentOperation(parentOperation);
  }
}
