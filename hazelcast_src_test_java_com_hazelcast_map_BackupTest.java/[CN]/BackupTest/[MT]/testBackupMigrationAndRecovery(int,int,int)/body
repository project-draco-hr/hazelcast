{
  TestHazelcastInstanceFactory nodeFactory=createHazelcastInstanceFactory(nodeCount);
  final String name=MAP_NAME;
  final Config config=new Config();
  config.setProperty(GroupProperties.PROP_PARTITION_COUNT,"1111");
  config.getMapConfig(name).setBackupCount(backupCount).setStatisticsEnabled(true);
  final HazelcastInstance[] instances=new HazelcastInstance[nodeCount];
  HazelcastInstance hz=nodeFactory.newHazelcastInstance(config);
  instances[0]=hz;
  IMap map1=hz.getMap(name);
  for (int i=0; i < mapSize; i++) {
    map1.put(i,"value" + i);
  }
  checkMapSizes(mapSize,backupCount,instances);
  for (int i=1; i < nodeCount; i++) {
    instances[i]=nodeFactory.newHazelcastInstance(config);
    checkMapSizes(mapSize,backupCount,instances);
  }
  final Random rand=new Random();
  for (int i=1; i < nodeCount; i++) {
    int ix;
    do {
      ix=rand.nextInt(nodeCount);
    }
 while (instances[ix] == null);
    final CountDownLatch latch=new CountDownLatch(1);
    instances[ix].getLifecycleService().addLifecycleListener(new LifecycleListener(){
      @Override public void stateChanged(      LifecycleEvent event){
        if (event.getState().equals(LifecycleEvent.LifecycleState.SHUTDOWN)) {
          latch.countDown();
        }
      }
    }
);
    latch.await(3,TimeUnit.SECONDS);
    TestUtil.terminateInstance(instances[ix]);
    instances[ix]=null;
    checkMapSizes(mapSize,backupCount,instances);
  }
}
