{
  while (true) {
    Call c=null;
    try {
      c=queue.take();
      callMap.put(c.getId(),c);
      boolean oldConnectionIsNotNull=(connection != null);
      long oldConnectionId=-1;
      if (oldConnectionIsNotNull) {
        oldConnectionId=connection.getVersion();
      }
      connection=client.connectionManager.getConnection();
      if (oldConnectionIsNotNull && connection.getVersion() != oldConnectionId) {
        System.out.println("Connection changed");
        temp.add(c);
        queue.drainTo(temp);
        client.listenerManager.getListenerCalls().drainTo(queue);
        temp.drainTo(queue);
        continue;
      }
      if (connection != null) {
        writer.write(connection,c.getRequest());
        System.out.println("Sending " + c + " "+ c.getRequest().getOperation());
      }
 else {
        interruptWaitingCalls();
      }
    }
 catch (    InterruptedException e) {
      return;
    }
catch (    Throwable io) {
      io.printStackTrace();
      enQueue(c);
      client.connectionManager.destroyConnection(connection);
    }
  }
}
