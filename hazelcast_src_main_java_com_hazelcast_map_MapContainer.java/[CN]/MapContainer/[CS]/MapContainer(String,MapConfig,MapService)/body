{
  Object store=null;
  this.name=name;
  this.mapConfig=mapConfig;
  this.mapService=mapService;
  MapStoreConfig mapStoreConfig=mapConfig.getMapStoreConfig();
  NodeEngine nodeEngine=mapService.getNodeEngine();
  if (mapStoreConfig != null) {
    try {
      MapStoreFactory factory=(MapStoreFactory)mapStoreConfig.getFactoryImplementation();
      if (factory == null) {
        String factoryClassName=mapStoreConfig.getFactoryClassName();
        if (factoryClassName != null && !"".equals(factoryClassName)) {
          factory=ClassLoaderUtil.newInstance(nodeEngine.getConfigClassLoader(),factoryClassName);
        }
      }
      store=(factory == null ? mapStoreConfig.getImplementation() : factory.newMapStore(name,mapStoreConfig.getProperties()));
      if (store == null) {
        String mapStoreClassName=mapStoreConfig.getClassName();
        store=ClassLoaderUtil.newInstance(nodeEngine.getConfigClassLoader(),mapStoreClassName);
      }
    }
 catch (    Exception e) {
      throw ExceptionUtil.rethrow(e);
    }
    storeWrapper=new MapStoreWrapper(store,mapConfig.getName(),mapStoreConfig.isEnabled());
  }
 else {
    storeWrapper=null;
  }
  if (storeWrapper != null) {
    if (store instanceof MapLoaderLifecycleSupport) {
      ((MapLoaderLifecycleSupport)store).init(nodeEngine.getHazelcastInstance(),mapStoreConfig.getProperties(),name);
    }
    if (nodeEngine.getClusterService().isMaster() && initialLoaded.compareAndSet(false,true)) {
      loadMapFromStore(true);
      Collection<MemberImpl> members=nodeEngine.getClusterService().getMemberList();
      for (      Member member : members) {
        try {
          if (member.localMember())           continue;
          MemberImpl memberImpl=(MemberImpl)member;
          Invocation invocation=nodeEngine.getOperationService().createInvocationBuilder(SERVICE_NAME,new MapInitialLoadOperation(name),memberImpl.getAddress()).build();
          invocation.invoke();
        }
 catch (        Throwable t) {
          throw ExceptionUtil.rethrow(t);
        }
      }
    }
 else {
      try {
        Invocation invocation=nodeEngine.getOperationService().createInvocationBuilder(SERVICE_NAME,new MapIsReadyOperation(name),nodeEngine.getMasterAddress()).build();
        Future future=invocation.invoke();
        mapReady=(Boolean)future.get();
        while (!mapReady) {
          Thread.sleep(1000);
          invocation=nodeEngine.getOperationService().createInvocationBuilder(SERVICE_NAME,new MapIsReadyOperation(name),nodeEngine.getMasterAddress()).build();
          future=invocation.invoke();
          boolean temp=(Boolean)future.get();
          if (!mapReady) {
            mapReady=temp;
          }
        }
      }
 catch (      Exception e) {
        throw ExceptionUtil.rethrow(e);
      }
    }
    if (mapStoreConfig.getWriteDelaySeconds() > 0) {
      mapStoreWriteScheduler=EntryTaskSchedulerFactory.newScheduler(nodeEngine.getExecutionService().getScheduledExecutor(),new MapStoreWriteProcessor(this,mapService),false);
      mapStoreDeleteScheduler=EntryTaskSchedulerFactory.newScheduler(nodeEngine.getExecutionService().getScheduledExecutor(),new MapStoreDeleteProcessor(this,mapService),false);
    }
 else {
      mapStoreDeleteScheduler=null;
      mapStoreWriteScheduler=null;
    }
  }
 else {
    mapReady=true;
    mapStoreDeleteScheduler=null;
    mapStoreWriteScheduler=null;
  }
  ttlEvictionScheduler=EntryTaskSchedulerFactory.newScheduler(nodeEngine.getExecutionService().getScheduledExecutor(),new EvictionProcessor(nodeEngine,mapService,name),true);
  idleEvictionScheduler=EntryTaskSchedulerFactory.newScheduler(nodeEngine.getExecutionService().getScheduledExecutor(),new EvictionProcessor(nodeEngine,mapService,name),true);
  WanReplicationRef wanReplicationRef=mapConfig.getWanReplicationRef();
  if (wanReplicationRef != null) {
    this.wanReplicationPublisher=nodeEngine.getWanReplicationService().getWanReplicationListener(wanReplicationRef.getName());
    this.wanMergePolicy=mapService.getMergePolicy(wanReplicationRef.getMergePolicy());
  }
 else {
    wanMergePolicy=null;
    wanReplicationPublisher=null;
  }
  interceptors=new CopyOnWriteArrayList<MapInterceptor>();
  interceptorMap=new ConcurrentHashMap<String,MapInterceptor>();
  nearCacheEnabled=mapConfig.getNearCacheConfig() != null;
  PartitioningStrategy strategy=null;
  PartitionStrategyConfig partitionStrategyConfig=mapConfig.getPartitionStrategyConfig();
  if (partitionStrategyConfig != null) {
    strategy=partitionStrategyConfig.getPartitionStrategy();
    if (strategy == null && partitionStrategyConfig.getPartitionStrategyClass() != null) {
      try {
        strategy=ClassLoaderUtil.newInstance(nodeEngine.getConfigClassLoader(),partitionStrategyConfig.getPartitionStrategyClass());
      }
 catch (      Exception e) {
        throw ExceptionUtil.rethrow(e);
      }
    }
  }
  partitionStrategy=strategy;
}
