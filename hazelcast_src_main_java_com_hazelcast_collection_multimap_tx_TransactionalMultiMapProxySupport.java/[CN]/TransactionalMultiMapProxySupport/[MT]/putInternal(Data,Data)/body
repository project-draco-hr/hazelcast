{
  throwExceptionIfNull(key);
  throwExceptionIfNull(value);
  Collection<CollectionRecord> coll=txMap.get(key);
  long timeout=tx.getTimeoutMillis();
  long ttl=timeout * 3 / 2;
  CollectionResponse response=lockAndGet(key,timeout,ttl,coll == null);
  if (response == null) {
    throw new ConcurrentModificationException("Transaction couldn't obtain lock " + getThreadId());
  }
  long recordId=(Long)response.getAttachment();
  if (coll == null) {
    coll=response.getRecordCollection(getNodeEngine());
    txMap.put(key,coll);
  }
  TxnPutOperation operation=new TxnPutOperation(proxyId,key,value,recordId,getThreadId());
  tx.addTransactionLog(new MultiMapTransactionLog(key,proxyId,ttl,getThreadId(),operation));
  CollectionRecord record=new CollectionRecord(recordId,config.isBinary() ? value : getNodeEngine().toObject(value));
  return coll.add(record);
}
