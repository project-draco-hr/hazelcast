{
synchronized (serviceMutex) {
    if (ownerBundle.getState() == Bundle.STOPPING) {
      try {
        shutdownAllInternal();
        try {
          ownerBundleContext.ungetService(serviceRegistration.getReference());
          serviceRegistration.unregister();
        }
 catch (        Throwable t) {
          LOGGER.finest("Error occurred while deregistering " + this,t);
        }
        LOGGER.info(this + " has been deregistered as OSGI service and deactivated");
      }
 catch (      Throwable t) {
        LOGGER.info(this + " will be forcefully deregistered as OSGI service " + "and will be forcefully deactivated");
        ExceptionUtil.rethrow(t);
      }
 finally {
        serviceRegistration=null;
      }
    }
  }
}
