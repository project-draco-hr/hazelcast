{
  HazelcastOSGiInstance hazelcastOSGiInstance;
  if (instance instanceof HazelcastOSGiInstance) {
    hazelcastOSGiInstance=(HazelcastOSGiInstance)instance;
  }
 else {
    hazelcastOSGiInstance=new HazelcastOSGiInstanceImpl(instance,this);
  }
  ServiceRegistration serviceRegistration;
  if (!Boolean.getBoolean(HAZELCAST_OSGI_REGISTER_DISABLED)) {
    serviceRegistration=ownerBundleContext.registerService(HazelcastInstance.class.getName(),hazelcastOSGiInstance,null);
  }
 else {
    serviceRegistration=EMPTY_SERVICE_REGISTRATION;
  }
  instanceServiceRegistrationMap.put(hazelcastOSGiInstance,serviceRegistration);
  instanceMap.put(instance.getName(),hazelcastOSGiInstance);
  return hazelcastOSGiInstance;
}
