{
  try {
    if (state != ACTIVE) {
      throw new TransactionNotActiveException("Transaction is not active");
    }
    checkThread();
    checkTimeout();
    ClientMessage request=TransactionPrepareParameters.encode(threadId,txnId);
    invoke(request);
    state=PREPARED;
  }
 catch (  Exception e) {
    state=ROLLING_BACK;
    closeConnection();
    throw ExceptionUtil.rethrow(e);
  }
}
