{
  if (state != Transaction.State.ACTIVE) {
    throw new TransactionNotActiveException("Transaction is not active!");
  }
  checkThread();
  if (record instanceof KeyAwareTransactionRecord) {
    KeyAwareTransactionRecord keyAwareTransactionRecord=(KeyAwareTransactionRecord)record;
    TransactionRecord removed=txLogMap.remove(keyAwareTransactionRecord.getKey());
    if (removed != null) {
      txLogs.remove(removed);
    }
  }
  txLogs.add(record);
  if (record instanceof KeyAwareTransactionRecord) {
    KeyAwareTransactionRecord keyAwareTransactionRecord=(KeyAwareTransactionRecord)record;
    txLogMap.put(keyAwareTransactionRecord.getKey(),keyAwareTransactionRecord);
  }
}
