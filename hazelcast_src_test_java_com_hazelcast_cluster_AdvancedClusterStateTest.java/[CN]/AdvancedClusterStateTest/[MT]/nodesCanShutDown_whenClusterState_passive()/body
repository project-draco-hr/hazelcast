{
  final TestHazelcastInstanceFactory factory=createHazelcastInstanceFactory(3);
  HazelcastInstance[] instances=factory.newInstances();
  warmUpPartitions(instances);
  waitAllForSafeState(instances);
  HazelcastInstance hz=instances[instances.length - 1];
  hz.getCluster().changeClusterState(ClusterState.PASSIVE);
  List<HazelcastInstance> instanceList=new ArrayList<HazelcastInstance>(Arrays.asList(instances));
  while (!instanceList.isEmpty()) {
    HazelcastInstance instanceToShutdown=instanceList.remove(0);
    instanceToShutdown.shutdown();
    for (    HazelcastInstance instance : instanceList) {
      assertClusterSizeEventually(instanceList.size(),instance);
    }
  }
}
