{
  if (dataValue == null) {
    dataValue=toData(value);
  }
  ResponseHandler responseHandler=getResponseHandler();
  MapService mapService=(MapService)getService();
  int partitionId=getPartitionId();
  PartitionContainer pc=mapService.getPartitionContainer(partitionId);
  if (txnId != null) {
    pc.addTransactionLogItem(txnId,new TransactionLogItem(name,dataKey,dataValue,false,false));
    responseHandler.sendResponse(null);
    return;
  }
  MapPartition mapPartition=pc.getMapPartition(name);
  Record record=mapPartition.records.get(dataKey);
  Object key=null;
  Object oldValue=null;
  Data oldValueData=null;
  if (record == null) {
    if (mapPartition.loader != null) {
      key=toObject(dataKey);
      oldValue=mapPartition.loader.load(key);
      oldValueData=toData(oldValue);
    }
    record=new DefaultRecord(null,partitionId,dataKey,dataValue,-1,-1,mapService.nextId());
    mapPartition.records.put(dataKey,record);
  }
 else {
    oldValueData=record.getValueData();
    record.setValueData(dataValue);
  }
  record.setActive();
  record.setDirty(true);
  if (mapPartition.store != null && mapPartition.writeDelayMillis == 0) {
    if (key == null) {
      key=toObject(dataKey);
    }
    mapPartition.store.store(key,record.getValue());
  }
  int mapBackupCount=mapPartition.getBackupCount();
  int backupCount=Math.min(getClusterSize() - 1,mapBackupCount);
  long version=pc.incrementAndGetVersion();
  if (backupCount > 0) {
    GenericBackupOperation op=new GenericBackupOperation(name,dataKey,dataValue,ttl,version);
    op.setBackupOpType(GenericBackupOperation.BackupOpType.PUT);
    op.setFirstCallerId(backupCallId,getCaller());
    try {
      getNodeService().sendBackups(MapService.MAP_SERVICE_NAME,op,partitionId,mapBackupCount);
    }
 catch (    Exception e) {
      e.printStackTrace();
    }
  }
  responseHandler.sendResponse(new UpdateResponse(oldValueData,version,backupCount));
}
