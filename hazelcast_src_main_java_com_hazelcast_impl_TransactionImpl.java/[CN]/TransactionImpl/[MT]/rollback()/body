{
  if (status == TXN_STATUS_NO_TXN || status == TXN_STATUS_UNKNOWN || status == TXN_STATUS_COMMITTED || status == TXN_STATUS_ROLLED_BACK)   throw new IllegalStateException("Transaction is not ready to rollback. Status= " + status);
  status=TXN_STATUS_ROLLING_BACK;
  try {
    ThreadContext.get().setCurrentFactory(factory);
    final int size=transactionRecords.size();
    ListIterator<TransactionRecord> iter=transactionRecords.listIterator(size);
    while (iter.hasPrevious()) {
      iter.previous().rollback();
    }
  }
 catch (  Exception e) {
    logger.log(Level.WARNING,e.getMessage(),e);
  }
 finally {
    finalizeTxn();
    status=TXN_STATUS_ROLLED_BACK;
  }
}
