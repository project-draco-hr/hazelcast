{
  int count=0;
  final MapProxyImpl mapProxy=(MapProxyImpl)map;
  final MapService mapService=(MapService)mapProxy.getService();
  final MapServiceContext mapServiceContext=mapService.getMapServiceContext();
  final NodeEngine nodeEngine=mapServiceContext.getNodeEngine();
  final InternalPartitionService partitionService=nodeEngine.getPartitionService();
  for (int i=0; i < partitionService.getPartitionCount(); i++) {
    PartitionContainer container=mapServiceContext.getPartitionContainer(i);
    RecordStore recordStore=container.getRecordStore(map.getName());
    if (recordStore == null) {
      continue;
    }
    Iterator<Record> iterator=recordStore.iterator(now,true);
    while (iterator.hasNext()) {
      iterator.next();
      count++;
    }
  }
  return count;
}
