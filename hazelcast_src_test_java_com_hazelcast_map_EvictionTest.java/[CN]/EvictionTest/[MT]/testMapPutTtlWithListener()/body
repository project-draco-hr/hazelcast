{
  Config cfg=new Config();
  TestHazelcastInstanceFactory factory=createHazelcastInstanceFactory(2);
  final HazelcastInstance[] instances=factory.newInstances(cfg);
  warmUpPartitions(instances);
  final int k=10;
  final int putCount=10000;
  final CountDownLatch latch=new CountDownLatch(k * putCount);
  final IMap map=instances[0].getMap("testMapEvictionTtlWithListener");
  final AtomicBoolean error=new AtomicBoolean(false);
  map.addEntryListener(new EntryAdapter(){
    public void entryEvicted(    EntryEvent event){
      final Long expectedEvictionTime=(Long)(event.getOldValue());
      long timeDifference=System.currentTimeMillis() - expectedEvictionTime;
      if (timeDifference > 5000) {
        error.set(true);
      }
      latch.countDown();
    }
  }
,true);
  for (int i=0; i < k; i++) {
    final int threadId=i;
    new Thread(){
      public void run(){
        int ttl=(int)(Math.random() * 5000 + 3000);
        for (int j=0; j < putCount; j++) {
          final long expectedEvictionTime=ttl + System.currentTimeMillis();
          map.put(j + putCount * threadId,expectedEvictionTime,ttl,TimeUnit.MILLISECONDS);
        }
      }
    }
.start();
  }
  assertTrue(latch.await(1,TimeUnit.MINUTES));
  assertFalse(error.get());
}
