{
  String[] args=null;
  Protocol auth;
  if (credentials instanceof UsernamePasswordCredentials) {
    UsernamePasswordCredentials upCredentials=(UsernamePasswordCredentials)credentials;
    args=new String[]{upCredentials.getUsername(),upCredentials.getPassword()};
    auth=new Protocol(null,Command.AUTH,args,null);
  }
 else {
    Data cr=serializationService.toData(credentials);
    auth=new Protocol(null,Command.AUTH,new String[]{},cr);
  }
  Protocol response=writeAndRead(connection,auth);
  logger.log(Level.FINEST,"auth response:" + response.command);
  if (!response.command.equals(Command.OK)) {
    throw new AuthenticationException("Client [" + connection + "] has failed authentication.");
  }
}
