{
  String[] args=null;
  ByteBuffer[] bb=null;
  if (credentials instanceof UsernamePasswordCredentials) {
    UsernamePasswordCredentials upCredentials=(UsernamePasswordCredentials)credentials;
    args=new String[]{upCredentials.getUsername(),upCredentials.getPassword()};
  }
 else {
    bb=new ByteBuffer[]{ByteBuffer.wrap(toByte(credentials))};
  }
  Protocol auth=new Protocol(null,Command.AUTH,args,bb);
  Protocol response=writeAndRead(connection,auth);
  logger.log(Level.FINEST,"auth response:" + response.command);
  if (!response.command.equals(Command.OK)) {
    throw new AuthenticationException("Client [" + connection + "] has failed authentication.");
  }
}
