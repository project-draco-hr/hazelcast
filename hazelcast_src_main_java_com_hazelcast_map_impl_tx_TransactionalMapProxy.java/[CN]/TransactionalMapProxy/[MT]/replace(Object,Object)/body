{
  checkTransactionState();
  MapService service=getService();
  MapServiceContext mapServiceContext=service.getMapServiceContext();
  Data keyData=mapServiceContext.toData(key,partitionStrategy);
  TxnValueWrapper wrapper=txMap.get(keyData);
  boolean haveTxnPast=wrapper != null;
  if (haveTxnPast) {
    if (wrapper.type == TxnValueWrapper.Type.REMOVED) {
      return null;
    }
    putInternal(keyData,mapServiceContext.toData(value));
    txMap.put(keyData,new TxnValueWrapper(value,TxnValueWrapper.Type.UPDATED));
    return wrapper.value;
  }
 else {
    Data oldValue=replaceInternal(keyData,mapServiceContext.toData(value));
    if (oldValue != null) {
      txMap.put(keyData,new TxnValueWrapper(value,TxnValueWrapper.Type.UPDATED));
    }
    return mapServiceContext.toObject(oldValue);
  }
}
