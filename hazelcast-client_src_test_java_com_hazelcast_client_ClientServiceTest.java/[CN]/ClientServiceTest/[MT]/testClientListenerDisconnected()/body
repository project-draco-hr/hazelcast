{
  Config config=new Config();
  config.setProperty(GroupProperties.PROP_IO_THREAD_COUNT,"1");
  HazelcastInstance hz=Hazelcast.newHazelcastInstance(config);
  HazelcastInstance hz2=Hazelcast.newHazelcastInstance(config);
  int clientCount=10;
  ClientDisconnectedListenerLatch listenerLatch=new ClientDisconnectedListenerLatch(clientCount);
  hz.getClientService().addClientListener(listenerLatch);
  hz2.getClientService().addClientListener(listenerLatch);
  Collection<HazelcastInstance> clients=new LinkedList<HazelcastInstance>();
  for (int i=0; i < clientCount; i++) {
    HazelcastInstance client=HazelcastClient.newHazelcastClient();
    IMap<Object,Object> map=client.getMap(randomMapName());
    map.addEntryListener(new EntryAdapter<Object,Object>(),true);
    map.put(generateKeyOwnedBy(hz),"value");
    map.put(generateKeyOwnedBy(hz2),"value");
    clients.add(client);
  }
  ExecutorService ex=Executors.newFixedThreadPool(4);
  try {
    for (    final HazelcastInstance client : clients) {
      ex.execute(new Runnable(){
        @Override public void run(){
          client.shutdown();
        }
      }
);
    }
    assertOpenEventually(listenerLatch,30);
    assertTrue(hz.getClientService().getConnectedClients().isEmpty());
    assertTrue(hz2.getClientService().getConnectedClients().isEmpty());
  }
  finally {
    ex.shutdown();
  }
}
