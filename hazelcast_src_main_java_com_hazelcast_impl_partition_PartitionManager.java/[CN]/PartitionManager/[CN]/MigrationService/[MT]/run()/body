{
  ThreadContext.get().setCurrentInstance(node.hazelcastInstance);
  try {
    while (running) {
      Runnable r=null;
      while (isActive() && (r=immediateTasksQueue.poll()) != null) {
        safeRunImmediate(r);
      }
      if (!running) {
        break;
      }
      long totalWait=0L;
      while (isActive() && (r != null || totalWait < partitionMigrationInterval)) {
        long start=Clock.currentTimeMillis();
        r=immediateTasksQueue.poll(1,TimeUnit.SECONDS);
        safeRunImmediate(r);
        totalWait+=(Clock.currentTimeMillis() - start);
      }
      if (isActive()) {
        r=scheduledTasksQueue.poll();
        safeRun(r);
      }
      if (!migrationActive.get() || hasNoTasks()) {
        Thread.sleep(250);
        continue;
      }
    }
  }
 catch (  InterruptedException e) {
    logger.log(Level.FINEST,"MigrationService is interrupted: " + e.getMessage(),e);
    running=false;
  }
 finally {
    clearTaskQueues();
  }
}
