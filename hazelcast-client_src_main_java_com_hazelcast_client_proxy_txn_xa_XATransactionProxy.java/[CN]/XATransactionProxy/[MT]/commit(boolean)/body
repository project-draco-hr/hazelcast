{
  checkTimeout();
  try {
    if (onePhase && state != ACTIVE) {
      throw new TransactionException("Transaction is not active");
    }
    if (!onePhase && state != PREPARED) {
      throw new TransactionException("Transaction is not prepared");
    }
    ClientMessage request=XATransactionCommitCodec.encodeRequest(txnId,onePhase);
    invoke(request);
    state=COMMITTED;
  }
 catch (  Exception e) {
    state=ROLLING_BACK;
    throw ExceptionUtil.rethrow(e);
  }
}
