{
  final Address thisAddress=node.getThisAddress();
  node.clusterManager.enqueueAndWait(new Processable(){
    public void process(){
      addActiveMigration(partitionId,replicaIndex,thisAddress,newAddress);
    }
  }
);
  long now=Clock.currentTimeMillis();
  final Collection<CMap> cmaps=node.concurrentMapManager.maps.values();
  CostAwareRecordList lsResultSet=new CostAwareRecordList(1000);
  for (  final CMap cmap : cmaps) {
    boolean includeCMap=diffOnly ? cmap.getTotalBackupCount() == replicaIndex : cmap.getTotalBackupCount() >= replicaIndex;
    if (includeCMap) {
      for (      Record rec : cmap.mapRecords.values()) {
        if (rec.isActive() && rec.isValid(now)) {
          if (rec.getKeyData() == null || rec.getKeyData().size() == 0) {
            throw new RuntimeException("Record.key is null or empty " + rec.getKeyData());
          }
          if (rec.getBlockId() == partitionId) {
            cmap.onMigrate(rec);
            if (cmap.isMultiMap()) {
              Collection<ValueHolder> colValues=rec.getMultiValues();
              for (              ValueHolder valueHolder : colValues) {
                Record record=rec.copy();
                record.setValueData(valueHolder.getData());
                lsResultSet.add(record);
              }
            }
 else {
              lsResultSet.add(rec);
            }
            lsResultSet.addCost(rec.getCost());
          }
        }
      }
    }
  }
  return lsResultSet;
}
