{
  final Address thisAddress=concurrentMapManager.node.getThisAddress();
  concurrentMapManager.enqueueAndWait(new Processable(){
    public void process(){
      addActiveMigration(partitionId,replicaIndex,thisAddress,newAddress);
    }
  }
);
  long now=Clock.currentTimeMillis();
  final Collection<CMap> cmaps=concurrentMapManager.maps.values();
  CostAwareRecordList lsResultSet=new CostAwareRecordList(1000);
  for (  final CMap cmap : cmaps) {
    boolean includeCMap=diffOnly ? cmap.getTotalBackupCount() == replicaIndex : cmap.getTotalBackupCount() >= replicaIndex;
    if (includeCMap) {
      for (      final Record record : cmap.mapRecords.values()) {
        if (record.isActive() && record.isValid(now)) {
          if (record.getKeyData() == null || record.getKeyData().size() == 0) {
            throw new RuntimeException("Record.key is null or empty " + record.getKeyData());
          }
          if (record.getBlockId() == partitionId) {
            concurrentMapManager.enqueueAndWait(new Processable(){
              public void process(){
                cmap.onMigrate(record);
              }
            }
);
            if (cmap.isMultiMap()) {
              final Collection<ValueHolder> colValues=record.getMultiValues();
              if (colValues != null) {
                for (                ValueHolder valueHolder : colValues) {
                  Record copy=record.copy();
                  copy.setValueData(valueHolder.getData());
                  lsResultSet.add(copy);
                }
              }
            }
 else {
              lsResultSet.add(record);
            }
            lsResultSet.addCost(record.getCost());
          }
        }
      }
    }
  }
  return lsResultSet;
}
