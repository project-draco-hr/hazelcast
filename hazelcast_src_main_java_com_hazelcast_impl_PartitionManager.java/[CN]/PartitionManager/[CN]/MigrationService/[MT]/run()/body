{
  try {
    while (running) {
      Runnable r=null;
      while (migrationActive.get() && (r=immediateTasksQueue.poll()) != null) {
        safeRunImmediate(r);
      }
      if (!running) {
        break;
      }
      if (!migrationActive.get() || scheduledTasksQueue.isEmpty()) {
        Thread.sleep(250);
        continue;
      }
      long totalWait=0L;
      while (migrationActive.get() && running && r == null && totalWait < partitionMigrationInterval) {
        long start=System.currentTimeMillis();
        r=immediateTasksQueue.poll(1,TimeUnit.SECONDS);
        safeRunImmediate(r);
        totalWait+=(System.currentTimeMillis() - start);
      }
      if (migrationActive.get() && running) {
        r=scheduledTasksQueue.poll();
        safeRun(r);
      }
    }
  }
 catch (  InterruptedException e) {
    logger.log(Level.FINEST,"MigrationService is interrupted: " + e.getMessage(),e);
    running=false;
  }
 finally {
    clearTaskQueues();
  }
}
