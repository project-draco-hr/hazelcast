{
  if (!QuickMath.isPowerOfTwo(buffer.length)) {
    throw new IllegalArgumentException("Size of the buffer has to be power of two, was " + buffer.length);
  }
  boolean isNull=str == null;
  out.writeBoolean(isNull);
  if (isNull) {
    return;
  }
  int length=str.length();
  out.writeInt(length);
  out.writeInt(length);
  if (length > 0) {
    int chunkSize=(length / STRING_CHUNK_SIZE) + 1;
    for (int i=0; i < chunkSize; i++) {
      int beginIndex=Math.max(0,i * STRING_CHUNK_SIZE - 1);
      int endIndex=Math.min((i + 1) * STRING_CHUNK_SIZE - 1,length);
      writeShortUTF(out,str,beginIndex,endIndex,buffer);
    }
  }
}
