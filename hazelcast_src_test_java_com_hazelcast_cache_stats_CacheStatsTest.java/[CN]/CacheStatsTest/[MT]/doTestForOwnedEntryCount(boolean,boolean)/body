{
  final String cacheName=randomName();
  ICache<Integer,String> cache;
  CacheStatistics[] allStats;
  HazelcastInstance instance2=null;
  if (useBackups) {
    instance2=getHazelcastInstance();
    CachingProvider cp=getCachingProvider(instance2);
    CacheManager cm=cp.getCacheManager();
    cache=createCache(cacheName);
    ICache<Integer,String> c=cm.getCache(cacheName).unwrap(ICache.class);
    allStats=new CacheStatistics[]{cache.getLocalCacheStatistics(),c.getLocalCacheStatistics()};
  }
 else {
    cache=createCache(cacheName);
    allStats=new CacheStatistics[]{cache.getLocalCacheStatistics()};
  }
  final int ENTRY_COUNT=100;
  for (int i=0; i < ENTRY_COUNT; i++) {
    cache.put(i,"Value-" + i);
  }
  assertEquals(ENTRY_COUNT,getOwnedEntryCount(allStats));
  if (triggerMigration && instance2 != null) {
    instance2.shutdown();
    allStats=new CacheStatistics[]{cache.getLocalCacheStatistics()};
    final CacheStatistics[] allStatistics=allStats;
    assertTrueEventually(new AssertTask(){
      @Override public void run() throws Exception {
        assertEquals(ENTRY_COUNT,getOwnedEntryCount(allStatistics));
      }
    }
);
  }
  for (int i=0; i < 10; i++) {
    cache.remove(i);
  }
  assertEquals(ENTRY_COUNT - 10,getOwnedEntryCount(allStats));
  for (int i=10; i < ENTRY_COUNT; i++) {
    cache.remove(i);
  }
  assertEquals(0,getOwnedEntryCount(allStats));
  for (int i=0; i < ENTRY_COUNT; i++) {
    cache.put(i,"Value-" + i);
  }
  assertEquals(ENTRY_COUNT,getOwnedEntryCount(allStats));
  if (triggerMigration) {
    instance2=getHazelcastInstance();
    CachingProvider cp=getCachingProvider(instance2);
    CacheManager cm=cp.getCacheManager();
    ICache<Integer,String> c=cm.getCache(cacheName).unwrap(ICache.class);
    allStats=new CacheStatistics[]{cache.getLocalCacheStatistics(),c.getLocalCacheStatistics()};
    final CacheStatistics[] allStatistics=allStats;
    assertTrueEventually(new AssertTask(){
      @Override public void run() throws Exception {
        assertEquals(ENTRY_COUNT,getOwnedEntryCount(allStatistics));
      }
    }
);
  }
  cache.clear();
  assertEquals(0,getOwnedEntryCount(allStats));
  for (int i=0; i < ENTRY_COUNT; i++) {
    cache.put(i,"Value-" + i);
  }
  assertEquals(ENTRY_COUNT,getOwnedEntryCount(allStats));
  cache.destroy();
  final CacheStatistics[] allStatistics=allStats;
  assertTrueEventually(new AssertTask(){
    @Override public void run() throws Exception {
      assertEquals(0,getOwnedEntryCount(allStatistics));
    }
  }
);
}
