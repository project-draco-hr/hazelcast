{
  final MapServiceContext mapServiceContext=mapService.getMapServiceContext();
  response=new MapEntrySet();
  final InternalPartitionService partitionService=getNodeEngine().getPartitionService();
  final RecordStore recordStore=mapServiceContext.getRecordStore(getPartitionId(),name);
  final LocalMapStatsImpl mapStats=mapServiceContext.getLocalMapStatsImpl(name);
  MapEntrySimple entry;
  for (  Data key : keys) {
    if (partitionService.getPartitionId(key) != getPartitionId()) {
      continue;
    }
    long start=System.currentTimeMillis();
    Object objectKey=mapServiceContext.toObject(key);
    final Map.Entry<Data,Object> mapEntry=recordStore.getMapEntry(key);
    final Object valueBeforeProcess=mapEntry.getValue();
    final Object valueBeforeProcessObject=mapServiceContext.toObject(valueBeforeProcess);
    entry=new MapEntrySimple(objectKey,valueBeforeProcessObject);
    final Object result=entryProcessor.process(entry);
    final Object valueAfterProcess=entry.getValue();
    Data dataValue=null;
    if (result != null) {
      dataValue=mapServiceContext.toData(result);
      response.add(new AbstractMap.SimpleImmutableEntry<Data,Data>(key,dataValue));
    }
    EntryEventType eventType;
    if (valueAfterProcess == null) {
      recordStore.remove(key);
      mapStats.incrementRemoves(getLatencyFrom(start));
      eventType=EntryEventType.REMOVED;
    }
 else {
      if (valueBeforeProcessObject == null) {
        mapStats.incrementPuts(getLatencyFrom(start));
        eventType=EntryEventType.ADDED;
      }
 else       if (!entry.isModified()) {
        mapStats.incrementGets(getLatencyFrom(start));
        eventType=__NO_NEED_TO_FIRE_EVENT;
      }
 else {
        mapStats.incrementPuts(getLatencyFrom(start));
        eventType=EntryEventType.UPDATED;
      }
      if (eventType != __NO_NEED_TO_FIRE_EVENT) {
        recordStore.put(new AbstractMap.SimpleImmutableEntry<Data,Object>(key,valueAfterProcess));
      }
    }
    if (eventType != __NO_NEED_TO_FIRE_EVENT) {
      final Data oldValue=mapServiceContext.toData(valueBeforeProcess);
      final Data value=mapServiceContext.toData(valueAfterProcess);
      mapServiceContext.getMapEventPublisher().publishEvent(getCallerAddress(),name,eventType,key,oldValue,value);
      if (mapServiceContext.getNearCacheProvider().isNearCacheAndInvalidationEnabled(name)) {
        mapServiceContext.getNearCacheProvider().invalidateAllNearCaches(name,key);
      }
      if (mapContainer.getWanReplicationPublisher() != null && mapContainer.getWanMergePolicy() != null) {
        if (EntryEventType.REMOVED.equals(eventType)) {
          mapServiceContext.getMapEventPublisher().publishWanReplicationRemove(name,key,Clock.currentTimeMillis());
        }
 else {
          Record record=recordStore.getRecord(key);
          Data tempValue=mapServiceContext.toData(dataValue);
          final EntryView entryView=EntryViews.createSimpleEntryView(key,tempValue,record);
          mapServiceContext.getMapEventPublisher().publishWanReplicationUpdate(name,entryView);
        }
      }
    }
  }
}
