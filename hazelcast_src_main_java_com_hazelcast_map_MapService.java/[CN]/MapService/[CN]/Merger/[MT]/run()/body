{
  for (  final MapContainer mapContainer : recordMap.keySet()) {
    MapMergePolicy mergePolicy=null;
    MapMergePolicyConfig mergePolicyConfig=mapContainer.getMapConfig().getMergePolicyConfig();
    if (mergePolicyConfig != null) {
      mergePolicy=mergePolicyConfig.getImplementation();
      if (mergePolicy == null) {
        String mergeClassName=mergePolicyConfig.getClassName();
        try {
          mergePolicy=ClassLoaderUtil.newInstance(mergeClassName);
        }
 catch (        Exception e) {
          logger.log(Level.SEVERE,e.getMessage(),e);
          ExceptionUtil.rethrow(e);
        }
      }
    }
    if (mergePolicy == null) {
      try {
        mergePolicy=ClassLoaderUtil.newInstance(MapMergePolicyConfig.DEFAULT_POLICY);
      }
 catch (      Exception e) {
        logger.log(Level.SEVERE,e.getMessage(),e);
        ExceptionUtil.rethrow(e);
      }
    }
    Collection<Record> recordList=recordMap.get(mapContainer);
    for (    final Record record : recordList) {
      final MapMergePolicy finalMergePolicy=mergePolicy;
      nodeEngine.getExecutionService().submit("hz:map-merge",new Runnable(){
        public void run(){
          SimpleEntryView entryView=new SimpleEntryView(record.getKey(),toData(record.getValue()),record);
          MergeOperation operation=new MergeOperation(mapContainer.getName(),record.getKey(),entryView,finalMergePolicy);
          try {
            int partitionId=nodeEngine.getPartitionService().getPartitionId(record.getKey());
            Invocation invocation=nodeEngine.getOperationService().createInvocationBuilder(SERVICE_NAME,operation,partitionId).build();
            invocation.invoke().get();
          }
 catch (          Throwable t) {
            ExceptionUtil.rethrow(t);
          }
        }
      }
);
    }
  }
}
