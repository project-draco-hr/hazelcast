{
  TestHazelcastInstanceFactory nodeFactory=createHazelcastInstanceFactory(3);
  Config cfg=new Config();
  cfg.getReplicatedMapConfig("default").setInMemoryFormat(inMemoryFormat);
  cfg.getReplicatedMapConfig("default").setReplicationDelayMillis(0);
  cfg.getReplicatedMapConfig("default").setConcurrencyLevel(1);
  HazelcastInstance instance1=nodeFactory.newHazelcastInstance(cfg);
  HazelcastInstance instance2=nodeFactory.newHazelcastInstance(cfg);
  HazelcastInstance instance3=nodeFactory.newHazelcastInstance(cfg);
  final ReplicatedMap<Object,Object> mapA=instance1.getReplicatedMap("default");
  final ReplicatedMap<Object,Object> mapB=instance2.getReplicatedMap("default");
  final ReplicatedMap<Object,Object> mapC=instance3.getReplicatedMap("default");
  Thread[] pool=new Thread[2];
  CyclicBarrier gate=new CyclicBarrier(pool.length + 1);
  pool[0]=new GatedThread(gate){
    public void go(){
      for (int i=0; i < 1000; i++) {
        mapA.put(i + "A",i);
      }
    }
  }
;
  pool[1]=new GatedThread(gate){
    public void go(){
      for (int i=0; i < 1000; i++) {
        mapB.put(i + "B",i);
      }
    }
  }
;
  for (  Thread t : pool) {
    t.start();
  }
  gate.await();
  for (  Thread t : pool) {
    t.join();
  }
  HazelcastTestSupport.assertTrueEventually(new AssertTask(){
    public void run(){
      assertEquals(2000,mapA.size());
      assertEquals(2000,mapB.size());
      assertEquals(2000,mapC.size());
    }
  }
);
  HazelcastTestSupport.assertTrueEventually(new AssertTask(){
    public void run(){
      for (int i=0; i < 1000; i++) {
        assertEquals(mapA.get(i + "A"),mapB.get(i + "A"));
        assertEquals(mapA.get(i + "A"),mapC.get(i + "A"));
        assertEquals(mapB.get(i + "A"),mapC.get(i + "A"));
        assertEquals(mapA.get(i + "B"),mapB.get(i + "B"));
        assertEquals(mapA.get(i + "B"),mapC.get(i + "B"));
        assertEquals(mapB.get(i + "B"),mapC.get(i + "B"));
      }
    }
  }
);
}
