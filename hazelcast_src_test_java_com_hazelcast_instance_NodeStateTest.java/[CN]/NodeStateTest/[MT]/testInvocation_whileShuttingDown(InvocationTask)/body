{
  CountDownLatch latch=new CountDownLatch(1);
  Config config=new Config();
  config.getServicesConfig().addServiceConfig(new ServiceConfig().setEnabled(true).setName("bs").setServiceImpl(new BlockingService(latch)));
  TestHazelcastInstanceFactory factory=createHazelcastInstanceFactory();
  final HazelcastInstance hz=factory.newHazelcastInstance(config);
  final Node node=getNode(hz);
  final Thread shutdownThread=new Thread(){
    public void run(){
      hz.shutdown();
    }
  }
;
  shutdownThread.start();
  waitNodeStateToBeShuttingDown(node);
  try {
    invocationTask.invoke(getNodeEngineImpl(hz));
  }
 catch (  Throwable e) {
    latch.countDown();
    throw ExceptionUtil.rethrow(e);
  }
  assertEquals(NodeState.SHUTTING_DOWN,node.getState());
  latch.countDown();
  shutdownThread.join(TimeUnit.MINUTES.toMillis(1));
  assertEquals(NodeState.SHUT_DOWN,node.getState());
}
