{
  checkIfLoaded();
  final long now=getNow();
  final Record record=getRecordOrNull(key,now,false);
  if (record == null) {
    return false;
  }
  final MapServiceContext mapServiceContext=this.mapServiceContext;
  final Object current=record.getValue();
  final String mapName=this.name;
  if (!mapServiceContext.compare(mapName,current,expect)) {
    return false;
  }
  update=mapServiceContext.interceptPut(mapName,current,update);
  update=mapDataStore.add(key,update,now);
  onStore(record);
  updateSizeEstimator(-calculateRecordHeapCost(record));
  updateRecord(record,update,now);
  updateSizeEstimator(calculateRecordHeapCost(record));
  saveIndex(record,current);
  return true;
}
