{
  checkIfLoaded();
  long now=getNow();
  Collection<Record> records=storage.values();
  Map<Data,Data> tempMap=EMPTY_MAP;
  for (  Record record : records) {
    Data key=record.getKey();
    record=getOrNullIfExpired(record,now,false);
    if (record == null) {
      continue;
    }
    if (tempMap == EMPTY_MAP) {
      tempMap=new HashMap<Data,Data>();
    }
    Data value=toData(record.getValue());
    tempMap.put(key,value);
  }
  return tempMap.entrySet();
}
