{
  SerializerAdapter adapter=createSerializerAdapter(serializer);
  if (!global.compareAndSet(null,adapter)) {
    throw new IllegalStateException("Global serializer is already registered!");
  }
  SerializerAdapter current=idMap.putIfAbsent(serializer.getTypeId(),adapter);
  if (current != null && current.getImpl().getClass() != adapter.getImpl().getClass()) {
    global.compareAndSet(adapter,null);
    throw new IllegalStateException("Serializer [" + current.getImpl() + "] has been already registered for type-id: "+ serializer.getTypeId());
  }
}
