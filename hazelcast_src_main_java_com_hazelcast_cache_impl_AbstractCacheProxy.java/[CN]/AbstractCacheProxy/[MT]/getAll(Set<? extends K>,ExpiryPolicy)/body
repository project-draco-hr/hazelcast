{
  ensureOpen();
  validateNotNull(keys);
  if (keys.isEmpty()) {
    return Collections.EMPTY_MAP;
  }
  final Set<Data> ks=new HashSet(keys.size());
  for (  K key : keys) {
    final Data k=serializationService.toData(key);
    ks.add(k);
  }
  final Map<K,V> result=new HashMap<K,V>();
  final Collection<Integer> partitions=getPartitionsForKeys(ks);
  try {
    OperationFactory factory=operationProvider.createGetAllOperationFactory(ks,expiryPolicy);
    OperationService operationService=getNodeEngine().getOperationService();
    Map<Integer,Object> responses=operationService.invokeOnPartitions(getServiceName(),factory,partitions);
    for (    Object response : responses.values()) {
      final Object responseObject=serializationService.toObject(response);
      final Set<Map.Entry<Data,Data>> entries=((MapEntrySet)responseObject).getEntrySet();
      for (      Map.Entry<Data,Data> entry : entries) {
        final V value=serializationService.toObject(entry.getValue());
        final K key=serializationService.toObject(entry.getKey());
        result.put(key,value);
      }
    }
  }
 catch (  Throwable e) {
    throw ExceptionUtil.rethrowAllowedTypeFirst(e,CacheException.class);
  }
  return result;
}
