{
  final Map<Integer,Integer> survivingPartitions=new HashMap<Integer,Integer>();
  for (  HazelcastInstance instance : instances) {
    final Node survivingNode=getNode(instance);
    final Address survivingNodeAddress=survivingNode.getThisAddress();
    for (    InternalPartition partition : survivingNode.getPartitionService().getPartitions()) {
      if (partition.isOwnerOrBackup(survivingNodeAddress)) {
        for (int replicaIndex=0; replicaIndex < getNodeCount(); replicaIndex++) {
          if (survivingNodeAddress.equals(partition.getReplicaAddress(replicaIndex))) {
            final Integer replicaIndexOfOtherInstance=survivingPartitions.get(partition.getPartitionId());
            if (replicaIndexOfOtherInstance != null) {
              survivingPartitions.put(partition.getPartitionId(),Math.min(replicaIndex,replicaIndexOfOtherInstance));
            }
 else {
              survivingPartitions.put(partition.getPartitionId(),replicaIndex);
            }
            break;
          }
        }
      }
    }
  }
  return survivingPartitions;
}
