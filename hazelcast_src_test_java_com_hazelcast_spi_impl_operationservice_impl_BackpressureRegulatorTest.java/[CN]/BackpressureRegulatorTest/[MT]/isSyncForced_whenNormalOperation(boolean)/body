{
  BackpressureRegulator regulator=newEnabledBackPressureService();
  BackupAwareOperation op;
  if (partitionSpecific) {
    op=new PartitionSpecificOperation(10);
  }
 else {
    op=new GenericOperation();
  }
  for (int iteration=0; iteration < 10; iteration++) {
    int initialSyncDelay=regulator.syncDelay((Operation)op);
    int remainingSyncDelay=initialSyncDelay - 1;
    for (int k=0; k < initialSyncDelay; k++) {
      boolean result=regulator.isSyncForced(op);
      assertFalse("no sync force expected",result);
      int syncDelay=regulator.syncDelay((Operation)op);
      assertEquals(remainingSyncDelay,syncDelay);
      remainingSyncDelay--;
    }
    boolean result=regulator.isSyncForced(op);
    assertTrue("sync force expected",result);
    AtomicInteger syncDelay=regulator.syncDelayCounter((Operation)op);
    assertValidSyncDelay(syncDelay);
  }
}
