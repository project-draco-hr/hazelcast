{
  final Set<MembershipListener> setListeners=refListeners.get();
  Set<ClusterMember> setNew=new LinkedHashSet<ClusterMember>(lsMembers.size());
  for (  MemberImpl member : lsMembers) {
    final ClusterMember dummy=new ClusterMember(member.getAddress(),member.localMember(),member.getNodeType());
    ClusterMember clusterMember=mapClusterMembers.get(dummy);
    if (clusterMember == null) {
      clusterMember=dummy;
      if (setListeners != null && setListeners.size() > 0) {
        ExecutorManager.get().executeLocaly(new Runnable(){
          public void run(){
            MembershipEvent membershipEvent=new MembershipEvent(ClusterImpl.this,dummy,MembershipEvent.MEMBER_ADDED);
            for (            MembershipListener listener : setListeners) {
              listener.memberAdded(membershipEvent);
            }
          }
        }
);
      }
    }
    if (clusterMember.localMember()) {
      refLocalMember.set(clusterMember);
    }
    setNew.add(clusterMember);
  }
  if (setListeners != null && setListeners.size() > 0) {
    Set<ClusterMember> it=mapClusterMembers.keySet();
    for (    final ClusterMember cm : it) {
      if (!setNew.contains(cm)) {
        ExecutorManager.get().executeLocaly(new Runnable(){
          public void run(){
            MembershipEvent membershipEvent=new MembershipEvent(ClusterImpl.this,cm,MembershipEvent.MEMBER_REMOVED);
            for (            MembershipListener listener : setListeners) {
              listener.memberRemoved(membershipEvent);
            }
          }
        }
);
      }
    }
  }
  mapClusterMembers.clear();
  for (  ClusterMember cm : setNew) {
    mapClusterMembers.put(cm,cm);
  }
  refMembers.set(setNew);
}
