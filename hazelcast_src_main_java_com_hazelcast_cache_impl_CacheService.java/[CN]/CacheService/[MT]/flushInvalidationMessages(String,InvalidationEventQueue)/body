{
  if (invalidationMessageQueue.flushingInProgress.compareAndSet(false,true)) {
    try {
      CacheBatchInvalidationMessage batchInvalidationMessage=new CacheBatchInvalidationMessage(cacheName,invalidationMessageQueue.size());
      CacheSingleInvalidationMessage invalidationMessage;
      while ((invalidationMessage=invalidationMessageQueue.poll()) != null) {
        batchInvalidationMessage.addInvalidationMessage(invalidationMessage);
      }
      EventService eventService=nodeEngine.getEventService();
      Collection<EventRegistration> registrations=eventService.getRegistrations(SERVICE_NAME,cacheName);
      if (!registrations.isEmpty()) {
        eventService.publishEvent(SERVICE_NAME,registrations,batchInvalidationMessage,cacheName.hashCode());
      }
    }
  finally {
      invalidationMessageQueue.flushingInProgress.set(false);
    }
  }
}
