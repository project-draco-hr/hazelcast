{
  Config config=new Config();
  final MigrationEventCounterService counter=new MigrationEventCounterService();
  ServiceConfig serviceConfig=new ServiceConfig().setEnabled(true).setName("event-counter").setServiceImpl(counter);
  config.getServicesConfig().addServiceConfig(serviceConfig);
  final HazelcastInstance hz=factory.newHazelcastInstance(config);
  warmUpPartitions(hz);
  final AssertTask assertTask=new AssertTask(){
    final InternalPartitionService partitionService=getNode(hz).getPartitionService();
    @Override public void run() throws Exception {
      assertEquals(0,partitionService.getMigrationQueueSize());
      assertEquals(counter.sourceCommits.get(),counter.destinationCommits.get());
    }
  }
;
  factory.newHazelcastInstance(config);
  assertTrueEventually(assertTask);
  factory.newHazelcastInstance(config);
  assertTrueEventually(assertTask);
}
