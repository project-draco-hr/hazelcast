{
  Config config=new Config();
  final String name=randomMapName();
  config.getMultiMapConfig(name).setValueCollectionType(MultiMapConfig.ValueCollectionType.LIST);
  final int insCount=4;
  TestHazelcastInstanceFactory factory=createHazelcastInstanceFactory(insCount);
  final HazelcastInstance[] instances=factory.newInstances(config);
  final Set keys=Collections.newSetFromMap(new ConcurrentHashMap());
  EntryListener listener=new EntryAdapter(){
    public void entryAdded(    EntryEvent event){
      keys.add(event.getKey());
    }
    public void entryRemoved(    EntryEvent event){
      keys.remove(event.getKey());
    }
    @Override public void mapCleared(    MapEvent event){
      keys.clear();
    }
  }
;
  final String id=instances[0].getMultiMap(name).addLocalEntryListener(listener);
  instances[0].getMultiMap(name).put("key1","val1");
  instances[0].getMultiMap(name).put("key2","val2");
  instances[0].getMultiMap(name).put("key3","val3");
  instances[0].getMultiMap(name).put("key4","val4");
  instances[0].getMultiMap(name).put("key5","val5");
  instances[0].getMultiMap(name).put("key6","val6");
  instances[0].getMultiMap(name).put("key7","val7");
  instances[0].getMultiMap(name).put("key8","val8");
  assertTrueEventually(new AssertTask(){
    @Override public void run() throws Exception {
      instances[0].getMultiMap(name).localKeySet().containsAll(keys);
    }
  }
);
  if (keys.size() != 0) {
    instances[0].getMultiMap(name).remove(keys.iterator().next());
  }
  assertTrueEventually(new AssertTask(){
    @Override public void run() throws Exception {
      instances[0].getMultiMap(name).localKeySet().containsAll(keys);
    }
  }
);
  instances[0].getMultiMap(name).removeEntryListener(id);
  getMultiMap(instances,name).clear();
  keys.clear();
  final String id2=instances[0].getMultiMap(name).addEntryListener(listener,true);
  getMultiMap(instances,name).put("key3","val3");
  getMultiMap(instances,name).put("key3","val33");
  getMultiMap(instances,name).put("key4","val4");
  getMultiMap(instances,name).remove("key3","val33");
  assertSizeEventually(1,keys);
  getMultiMap(instances,name).clear();
  assertSizeEventually(0,keys);
  instances[0].getMultiMap(name).removeEntryListener(id2);
  instances[0].getMultiMap(name).addEntryListener(listener,"key7",true);
  getMultiMap(instances,name).put("key2","val2");
  getMultiMap(instances,name).put("key3","val3");
  getMultiMap(instances,name).put("key7","val7");
  assertSizeEventually(1,keys);
}
