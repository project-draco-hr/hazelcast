{
  List<HazelcastInstance> instances=getCreatedInstancesShuffledAfterWarmedUp();
  List<HazelcastInstance> survivingInstances=new ArrayList<HazelcastInstance>(instances);
  List<HazelcastInstance> terminatingInstances=survivingInstances.subList(0,numberOfNodesToCrash);
  survivingInstances=survivingInstances.subList(numberOfNodesToCrash,instances.size());
  HazelcastInstance instance=survivingInstances.get(0);
  HazelcastServerCachingProvider cachingProvider=createCachingProvider(instance);
  CacheManager cacheManager=cachingProvider.getCacheManager();
  List<EventCollectingCachePartitionLostListener> listeners=registerListeners(cacheManager);
  if (withData) {
    for (int i=0; i < getNodeCount(); i++) {
      Cache<Integer,Integer> cache=cacheManager.getCache(getIthCacheName(i));
      for (int j=0; j < getCacheEntryCount(); j++) {
        cache.put(j,j);
      }
    }
  }
  String log="Surviving: " + survivingInstances + " Terminating: "+ terminatingInstances;
  Map<Integer,Integer> survivingPartitions=getMinReplicaIndicesByPartitionId(survivingInstances);
  terminateInstances(terminatingInstances);
  waitAllForSafeState(survivingInstances);
  for (int i=0; i < getNodeCount(); i++) {
    assertListenerInvocationsEventually(log,i,numberOfNodesToCrash,listeners.get(i),survivingPartitions);
  }
  for (int i=0; i < getNodeCount(); i++) {
    cacheManager.destroyCache(getIthCacheName(i));
  }
  cacheManager.close();
  cachingProvider.close();
}
