{
  boolean updated=false;
  while (true) {
    Expirable original=cache.get(key);
    Expirable revised;
    long timestamp=nextTimestamp();
    if (original == null) {
      revised=new Value(newVersion,timestamp,newValue);
      updated=true;
      if (cache.putIfAbsent(key,revised) == null) {
        break;
      }
    }
 else {
      if (softLock instanceof MarkerWrapper) {
        final ExpiryMarker unwrappedMarker=((MarkerWrapper)softLock).getMarker();
        if (original.matches(unwrappedMarker)) {
          final ExpiryMarker marker=(ExpiryMarker)original;
          if (marker.isConcurrent()) {
            revised=marker.expire(timestamp);
            updated=false;
          }
 else {
            revised=new Value(newVersion,timestamp,newValue);
            updated=true;
          }
          if (cache.replace(key,original,revised)) {
            break;
          }
        }
 else         if (original.getValue() == null) {
          updated=false;
          break;
        }
 else {
          revised=new ExpiryMarker(newVersion,timestamp,nextMarkerId()).expire(timestamp);
          updated=false;
          if (cache.replace(key,original,revised)) {
            break;
          }
        }
      }
 else {
        break;
      }
    }
  }
  maybeNotifyTopic(key,newValue,newVersion);
  return updated;
}
