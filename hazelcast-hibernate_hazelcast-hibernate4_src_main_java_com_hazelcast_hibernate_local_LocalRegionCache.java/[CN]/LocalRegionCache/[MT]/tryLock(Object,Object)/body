{
  ExpiryMarker marker;
  String markerId=nextMarkerId();
  while (true) {
    final Expirable original=cache.get(key);
    long timeout=nextTimestamp() + CacheEnvironment.getDefaultCacheTimeoutInMillis();
    if (original == null) {
      marker=new ExpiryMarker(version,timeout,markerId);
      if (cache.putIfAbsent(key,marker) == null) {
        break;
      }
    }
 else {
      marker=original.markForExpiration(timeout,markerId);
      if (cache.replace(key,original,marker)) {
        break;
      }
    }
  }
  return marker;
}
