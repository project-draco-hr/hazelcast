{
  List<EvictionEntry> entries=null;
  Iterator<Entry<Object,Expirable>> iter=cache.entrySet().iterator();
  long now=nextTimestamp();
  while (iter.hasNext()) {
    final Entry<Object,Expirable> e=iter.next();
    final Object k=e.getKey();
    final Expirable expirable=e.getValue();
    if (expirable instanceof ExpiryMarker) {
      continue;
    }
    final Value v=(Value)expirable;
    if (timeToLive > 0 && v.getTimestamp() + timeToLive < now) {
      iter.remove();
    }
 else     if (limitSize) {
      if (entries == null) {
        entries=new ArrayList<EvictionEntry>(cache.size());
      }
      entries.add(new EvictionEntry(k,v));
    }
  }
  return entries;
}
