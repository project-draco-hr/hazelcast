{
  final ThreadContext threadContext=ThreadContext.get();
  threadContext.setCurrentSerializerRegistry(client.getSerializerRegistry());
  byte[] k=null;
  byte[] v=null;
  if (key != null) {
    k=threadContext.toByteArray(key);
  }
  if (value != null) {
    v=threadContext.toByteArray(value);
  }
  Packet packet=createRequestPacket(operation,k,v,ttl,timeunit);
  if (key instanceof PartitionAware) {
    Object partitionKey=((PartitionAware)key).getPartitionKey();
    if (partitionKey == null)     throw new IllegalArgumentException("PartitionKey cannot be null!");
    packet.setKeyHash(Util.hashCode(threadContext.toByteArray(partitionKey)));
  }
  if (value instanceof PartitionAware) {
    Object partitionKey=((PartitionAware)value).getPartitionKey();
    if (partitionKey == null)     throw new IllegalArgumentException("PartitionKey cannot be null!");
    packet.setValueHash(Util.hashCode(threadContext.toByteArray(partitionKey)));
  }
  return packet;
}
