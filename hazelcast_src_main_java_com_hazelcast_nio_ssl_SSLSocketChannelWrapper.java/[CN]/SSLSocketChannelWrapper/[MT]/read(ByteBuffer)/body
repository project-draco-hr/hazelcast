{
  if (!handshake) {
    handshake();
  }
  int readBytesCount=0;
  int limit;
  if (in.hasRemaining()) {
    limit=Math.min(in.remaining(),output.remaining());
    for (int i=0; i < limit; i++) {
      output.put(in.get());
      readBytesCount++;
    }
    return readBytesCount;
  }
  if (netInBuffer.hasRemaining()) {
    unwrap(netInBuffer);
    limit=Math.min(in.limit(),output.remaining());
    for (int i=0; i < limit; i++) {
      output.put(in.get());
      readBytesCount++;
    }
    if (sslEngineResult.getStatus() != SSLEngineResult.Status.BUFFER_UNDERFLOW) {
      netInBuffer.clear();
      netInBuffer.flip();
      return readBytesCount;
    }
  }
  if (netInBuffer.hasRemaining()) {
    netInBuffer.compact();
  }
 else {
    netInBuffer.clear();
  }
  if (socketChannel.read(netInBuffer) == -1) {
    netInBuffer.clear();
    netInBuffer.flip();
    return -1;
  }
  netInBuffer.flip();
  unwrap(netInBuffer);
  limit=Math.min(in.limit(),output.remaining());
  for (int i=0; i < limit; i++) {
    output.put(in.get());
    readBytesCount++;
  }
  return readBytesCount;
}
