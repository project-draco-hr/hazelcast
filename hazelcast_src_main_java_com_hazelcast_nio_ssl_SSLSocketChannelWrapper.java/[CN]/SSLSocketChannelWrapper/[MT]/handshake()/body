{
  if (handshakeCompleted) {
    return;
  }
  if (DEBUG) {
    log("Starting handshake...");
  }
synchronized (this) {
    if (handshakeCompleted) {
      if (DEBUG) {
        log("Handshake already completed...");
      }
      return;
    }
    int counter=0;
    if (DEBUG) {
      log("Begin handshake");
    }
    sslEngine.beginHandshake();
    writeInternal(emptyBuffer);
    while (counter++ < 250 && sslEngineResult.getHandshakeStatus() != SSLEngineResult.HandshakeStatus.FINISHED) {
      if (DEBUG) {
        log("Handshake status: " + sslEngineResult.getHandshakeStatus());
      }
      if (sslEngineResult.getHandshakeStatus() == SSLEngineResult.HandshakeStatus.NEED_UNWRAP) {
        if (DEBUG) {
          log("Begin UNWRAP");
        }
        netInBuffer.clear();
        while (socketChannel.read(netInBuffer) < 1) {
          try {
            if (DEBUG) {
              log("Spinning on channel read...");
            }
            Thread.sleep(50);
          }
 catch (          InterruptedException e) {
            throw new IOException(e);
          }
        }
        netInBuffer.flip();
        unwrap(netInBuffer);
        if (DEBUG) {
          log("Done UNWRAP: " + sslEngineResult.getHandshakeStatus());
        }
        if (sslEngineResult.getHandshakeStatus() != SSLEngineResult.HandshakeStatus.FINISHED) {
          emptyBuffer.clear();
          writeInternal(emptyBuffer);
          if (DEBUG) {
            log("Done WRAP after UNWRAP: " + sslEngineResult.getHandshakeStatus());
          }
        }
      }
 else       if (sslEngineResult.getHandshakeStatus() == SSLEngineResult.HandshakeStatus.NEED_WRAP) {
        if (DEBUG) {
          log("Begin WRAP");
        }
        emptyBuffer.clear();
        writeInternal(emptyBuffer);
        if (DEBUG) {
          log("Done WRAP: " + sslEngineResult.getHandshakeStatus());
        }
      }
 else {
        try {
          if (DEBUG) {
            log("Sleeping... Status: " + sslEngineResult.getHandshakeStatus());
          }
          Thread.sleep(500);
        }
 catch (        InterruptedException e) {
          throw new IOException(e);
        }
      }
    }
    if (sslEngineResult.getHandshakeStatus() != SSLEngineResult.HandshakeStatus.FINISHED) {
      throw new SSLHandshakeException("SSL handshake failed after " + counter + " trials! -> "+ sslEngineResult.getHandshakeStatus());
    }
    if (DEBUG) {
      log("Handshake completed!");
    }
    in.clear();
    in.flip();
    handshakeCompleted=true;
  }
}
