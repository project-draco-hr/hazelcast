{
  final SerializationService ss=client.getSerializationService();
  byte serializationVersion=ss.getVersion();
  String uuid=null;
  String ownerUuid=null;
  if (principal != null) {
    uuid=principal.getUuid();
    ownerUuid=principal.getOwnerUuid();
  }
  ClientMessage clientMessage;
  if (credentials.getClass().equals(UsernamePasswordCredentials.class)) {
    UsernamePasswordCredentials cr=(UsernamePasswordCredentials)credentials;
    clientMessage=ClientAuthenticationCodec.encodeRequest(cr.getUsername(),cr.getPassword(),uuid,ownerUuid,true,ClientTypes.JAVA,serializationVersion);
  }
 else {
    Data data=ss.toData(credentials);
    clientMessage=ClientAuthenticationCustomCodec.encodeRequest(data,uuid,ownerUuid,true,ClientTypes.JAVA,serializationVersion);
  }
  connection.init();
  ClientMessage response;
  final ClientInvocation clientInvocation=new ClientInvocation(client,clientMessage,connection);
  final Future<ClientMessage> future=clientInvocation.invoke();
  try {
    response=future.get();
  }
 catch (  Exception e) {
    throw ExceptionUtil.rethrow(e,IOException.class);
  }
  ClientAuthenticationCodec.ResponseParameters result=ClientAuthenticationCodec.decodeResponse(response);
  AuthenticationStatus authenticationStatus=AuthenticationStatus.getById(result.status);
switch (authenticationStatus) {
case AUTHENTICATED:
    connection.setRemoteEndpoint(result.address);
  connection.setIsAuthenticatedAsOwner();
principal=new ClientPrincipal(result.uuid,result.ownerUuid);
return;
case CREDENTIALS_FAILED:
throw new AuthenticationException("Invalid credentials!");
default :
throw new AuthenticationException("Authentication status code not supported. status:" + authenticationStatus);
}
}
