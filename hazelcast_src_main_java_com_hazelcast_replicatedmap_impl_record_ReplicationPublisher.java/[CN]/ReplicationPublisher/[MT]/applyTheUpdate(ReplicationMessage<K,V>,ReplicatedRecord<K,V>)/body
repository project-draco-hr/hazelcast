{
  VectorClockTimestamp remoteVectorClockTimestamp=update.getVectorClockTimestamp();
  K marshalledKey=(K)replicatedRecordStore.marshallKey(update.getKey());
  V marshalledValue=(V)replicatedRecordStore.marshallValue(update.getValue());
  long ttlMillis=update.getTtlMillis();
  long oldTtlMillis=localEntry.getTtlMillis();
  Object oldValue=localEntry.setValueInternal(marshalledValue,update.getUpdateHash(),ttlMillis);
  localEntry.applyVectorClock(remoteVectorClockTimestamp);
  if (ttlMillis > 0 || update.isRemove()) {
    replicatedRecordStore.scheduleTtlEntry(ttlMillis,marshalledKey,null);
  }
 else {
    replicatedRecordStore.cancelTtlEntry(marshalledKey);
  }
  V unmarshalledOldValue=(V)replicatedRecordStore.unmarshallValue(oldValue);
  if (unmarshalledOldValue == null || !unmarshalledOldValue.equals(update.getValue()) || update.getTtlMillis() != oldTtlMillis) {
    replicatedRecordStore.fireEntryListenerEvent(update.getKey(),unmarshalledOldValue,update.getValue());
  }
}
