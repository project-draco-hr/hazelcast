{
  final Connection conn=packet.getConn();
  final ClientEndpoint endpoint=getEndpoint(conn);
  try {
    final Data data=packet.getData();
    final ClientRequest request=(ClientRequest)serializationService.toObject(data);
    if (endpoint.isAuthenticated() || request instanceof AuthenticationRequest) {
      request.setEndpoint(endpoint);
      final String serviceName=request.getServiceName();
      if (serviceName != null) {
        final Object service=nodeEngine.getService(serviceName);
        if (service == null) {
          if (nodeEngine.isActive()) {
            throw new IllegalArgumentException("No service registered with name: " + serviceName);
          }
          throw new HazelcastInstanceNotActiveException();
        }
        request.setService(service);
        if (request instanceof InitializingRequest) {
          Object objectId=((InitializingRequest)request).getObjectId();
          nodeEngine.getProxyService().initializeDistributedObject(serviceName,objectId);
        }
      }
      request.setClientEngine(ClientEngineImpl.this);
      request.process();
    }
 else {
      String message="Client " + conn + " must authenticate before any operation.";
      logger.log(Level.SEVERE,message);
      sendResponse(endpoint,new AuthenticationException(message));
      removeEndpoint(conn);
    }
  }
 catch (  Throwable e) {
    final Level level=nodeEngine.isActive() ? Level.SEVERE : Level.FINEST;
    logger.log(level,e.getMessage(),e);
    sendResponse(endpoint,e);
  }
}
