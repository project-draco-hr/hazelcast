{
  long start=Clock.currentTimeMillis();
  logger.log(Level.FINE,"** we are being asked to shutdown when active = " + String.valueOf(active));
  if (!force && isActive()) {
    final int maxWaitSeconds=groupProperties.GRACEFUL_SHUTDOWN_MAX_WAIT.getInteger();
    int waitSeconds=0;
    do {
      try {
        Thread.sleep(500);
      }
 catch (      InterruptedException e) {
      }
    }
 while (concurrentMapManager.partitionManager.hasActiveBackupTask() && ++waitSeconds < maxWaitSeconds);
    if (waitSeconds >= maxWaitSeconds) {
      logger.log(Level.WARNING,"Graceful shutdown could not be completed in " + maxWaitSeconds + " seconds!");
    }
  }
  if (isActive()) {
    joined.set(false);
    setActive(false);
    setMasterAddress(null);
    wanReplicationService.shutdown();
    try {
      Runtime.getRuntime().removeShutdownHook(shutdownHookThread);
    }
 catch (    Throwable ignored) {
    }
    if (managementCenterService != null) {
      managementCenterService.shutdown();
    }
    logger.log(Level.FINEST,"Shutting down the clientHandlerService");
    clientHandlerService.shutdown();
    logger.log(Level.FINEST,"Shutting down the partitionManager");
    partitionManager.shutdown();
    logger.log(Level.FINEST,"Shutting down the concurrentMapManager");
    concurrentMapManager.shutdown();
    logger.log(Level.FINEST,"Shutting down the cluster service");
    clusterService.stop();
    if (multicastService != null) {
      logger.log(Level.FINEST,"Shutting down the multicast service");
      multicastService.stop();
    }
    logger.log(Level.FINEST,"Shutting down the connection manager");
    connectionManager.shutdown();
    logger.log(Level.FINEST,"Shutting down the executorManager");
    executorManager.stop();
    textCommandService.stop();
    masterAddress=null;
    if (securityContext != null) {
      securityContext.destroy();
    }
    initializer.destroy();
    int numThreads=threadGroup.activeCount();
    Thread[] threads=new Thread[numThreads * 2];
    numThreads=threadGroup.enumerate(threads,false);
    for (int i=0; i < numThreads; i++) {
      Thread thread=threads[i];
      logger.log(Level.FINEST,"Shutting down thread " + thread.getName());
      thread.interrupt();
    }
    failedConnections.clear();
    serviceThreadPacketQueue.clear();
    systemLogService.shutdown();
    ThreadContext.get().shutdown(factory);
    logger.log(Level.INFO,"Hazelcast Shutdown is completed in " + (Clock.currentTimeMillis() - start) + " ms.");
  }
}
