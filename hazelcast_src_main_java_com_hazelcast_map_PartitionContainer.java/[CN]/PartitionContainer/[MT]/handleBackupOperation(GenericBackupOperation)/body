{
  if (op.version == version + 1) {
    op.backupAndReturn();
    version++;
    while (waitingBackupOps.size() > 0) {
      GenericBackupOperation backupOp=waitingBackupOps.remove(version + 1);
      if (backupOp != null) {
        backupOp.doBackup();
        version++;
      }
 else {
        return;
      }
    }
  }
 else   if (op.version <= version) {
    op.sendResponse();
  }
 else {
    waitingBackupOps.put(op.version,op);
    op.sendResponse();
  }
  if (waitingBackupOps.size() > 3) {
    Set<GenericBackupOperation> ops=new TreeSet<GenericBackupOperation>(waitingBackupOps.values());
    for (    GenericBackupOperation backupOp : ops) {
      backupOp.doBackup();
      version=backupOp.version;
    }
    waitingBackupOps.clear();
  }
}
