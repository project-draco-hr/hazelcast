{
  final HzClusterUtil a=new HzClusterUtil("A",25701,4);
  for (  Config cfg : a.getConfigs()) {
    cfg.getReplicatedMapConfig("default").setInMemoryFormat(inMemoryFormat);
    cfg.getReplicatedMapConfig("default").setReplicationDelayMillis(delay);
  }
  a.initCluster();
  for (int i=0; i < 100; i++) {
    a.getRandomNode().getReplicatedMap("default").put(i,i);
  }
  HzClusterUtil.assertTrueEventually(new AssertTask(){
    public void run(){
      for (      HazelcastInstance hz : a.getCluster())       assertEquals(100,hz.getReplicatedMap("default").size());
    }
  }
);
  final HzClusterUtil b=a.splitCluster();
  a.assertClusterSizeEventually(2);
  b.assertClusterSizeEventually(2);
  HzClusterUtil.assertTrueEventually(new AssertTask(){
    public void run(){
      for (      HazelcastInstance hz : a.getCluster())       assertEquals(100,hz.getReplicatedMap("default").size());
      for (      HazelcastInstance hz : b.getCluster())       assertEquals(100,hz.getReplicatedMap("default").size());
    }
  }
);
  for (int i=0; i < 100; i++) {
    a.getRandomNode().getReplicatedMap("default").put(i + "A",i);
    b.getRandomNode().getReplicatedMap("default").put(i + "B",i);
  }
  HzClusterUtil.assertTrueEventually(new AssertTask(){
    public void run(){
      for (      HazelcastInstance hz : a.getCluster())       assertEquals(200,hz.getReplicatedMap("default").size());
      for (      HazelcastInstance hz : b.getCluster())       assertEquals(200,hz.getReplicatedMap("default").size());
    }
  }
);
  a.mergeCluster(b);
  a.assertClusterSizeEventually(4);
  HzClusterUtil.assertTrueEventually(new AssertTask(){
    public void run(){
      for (      HazelcastInstance hz : a.getCluster())       assertEquals(300,hz.getReplicatedMap("default").size());
    }
  }
);
}
