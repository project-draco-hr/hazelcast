{
  if (version < 0) {
    version=0;
  }
  if (config != null) {
    addConfigDataSerializableFactories(dataSerializableFactories,config,classLoader);
    addConfigPortableFactories(portableFactories,config,classLoader);
    classDefinitions.addAll(config.getClassDefinitions());
  }
  final InputOutputFactory inputOutputFactory=createInputOutputFactory();
  final SerializationService ss=new SerializationServiceImpl(inputOutputFactory,version,classLoader,dataSerializableFactories,portableFactories,classDefinitions,checkClassDefErrors,managedContext,enableCompression,enableSharedObject);
  if (config != null) {
    if (config.getGlobalSerializerConfig() != null) {
      GlobalSerializerConfig globalSerializerConfig=config.getGlobalSerializerConfig();
      Serializer serializer=globalSerializerConfig.getImplementation();
      if (serializer == null) {
        try {
          serializer=ClassLoaderUtil.newInstance(classLoader,globalSerializerConfig.getClassName());
        }
 catch (        Exception e) {
          throw new HazelcastSerializationException(e);
        }
      }
      if (serializer instanceof HazelcastInstanceAware) {
        ((HazelcastInstanceAware)serializer).setHazelcastInstance(hazelcastInstance);
      }
      ss.registerGlobal(serializer);
    }
    final Collection<SerializerConfig> typeSerializers=config.getSerializerConfigs();
    for (    SerializerConfig serializerConfig : typeSerializers) {
      Serializer serializer=serializerConfig.getImplementation();
      if (serializer == null) {
        try {
          serializer=ClassLoaderUtil.newInstance(classLoader,serializerConfig.getClassName());
        }
 catch (        Exception e) {
          throw new HazelcastSerializationException(e);
        }
      }
      if (serializer instanceof HazelcastInstanceAware) {
        ((HazelcastInstanceAware)serializer).setHazelcastInstance(hazelcastInstance);
      }
      Class typeClass=serializerConfig.getTypeClass();
      if (typeClass == null) {
        try {
          typeClass=ClassLoaderUtil.loadClass(classLoader,serializerConfig.getTypeClassName());
        }
 catch (        ClassNotFoundException e) {
          throw new HazelcastSerializationException(e);
        }
      }
      ss.register(typeClass,serializer);
    }
  }
  return ss;
}
