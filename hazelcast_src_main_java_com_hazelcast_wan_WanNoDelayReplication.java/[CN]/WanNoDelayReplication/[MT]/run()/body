{
  Connection conn=null;
  while (running) {
    try {
      WanReplicationEvent operation=(failureQ.size() > 0) ? failureQ.removeFirst() : q.take();
      if (conn == null) {
        conn=getConnection();
        if (conn != null) {
          boolean authorized=checkAuthorization(groupName,password,conn.getEndPoint());
          if (!authorized) {
            conn.close();
            conn=null;
            if (logger != null) {
              logger.log(Level.SEVERE,"Invalid groupName or groupPassword! ");
            }
          }
        }
      }
      if (conn != null && conn.live()) {
        Data data=node.nodeEngine.getSerializationService().toData(operation);
        Packet operationPacket=new Packet(data,node.nodeEngine.getSerializationContext());
        operationPacket.setHeader(Packet.HEADER_WAN_REPLICATION,true);
        System.out.println("send oper" + operation);
        node.nodeEngine.send(operationPacket,conn);
      }
 else {
        failureQ.addFirst(operation);
        conn=null;
      }
    }
 catch (    InterruptedException e) {
      running=false;
    }
catch (    Throwable e) {
      if (logger != null) {
        logger.log(Level.WARNING,e.getMessage(),e);
      }
      conn=null;
    }
  }
}
