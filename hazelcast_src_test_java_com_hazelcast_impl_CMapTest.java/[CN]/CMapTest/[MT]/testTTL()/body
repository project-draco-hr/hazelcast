{
  Config config=new Config();
  FactoryImpl mockFactory=mock(FactoryImpl.class);
  Node node=new Node(mockFactory,config);
  node.serviceThread=Thread.currentThread();
  CMap cmap=new CMap(node.concurrentMapManager,"c:myMap");
  Object key="1";
  Object value="istanbul";
  Data dKey=toData(key);
  Data dValue=toData(value);
  Request reqPut=newPutRequest(dKey,dValue);
  reqPut.ttl=3000;
  cmap.put(reqPut);
  assertTrue(cmap.mapRecords.containsKey(toData(key)));
  Data actualValue=cmap.get(newGetRequest(dKey));
  assertThat(toObject(actualValue),equalTo(value));
  assertEquals(1,cmap.mapRecords.size());
  Record record=cmap.getRecord(dKey);
  assertNotNull(record);
  assertTrue(record.isActive());
  assertTrue(record.isValid());
  assertEquals(1,cmap.size());
  assertNotNull(cmap.get(newGetRequest(dKey)));
  assertEquals(dValue,cmap.get(newGetRequest(dKey)));
  assertTrue(record.getRemainingTTL() > 1000);
  Thread.sleep(1000);
  assertTrue(record.getRemainingTTL() < 2100);
  cmap.put(newPutRequest(dKey,dValue));
  assertTrue(record.getRemainingTTL() > 2001);
  assertTrue(record.isActive());
  assertTrue(record.isValid());
  Thread.sleep(1000);
  assertTrue(record.getRemainingTTL() < 2100);
  cmap.put(newPutRequest(dKey,dValue));
  assertTrue(record.getRemainingTTL() > 2001);
  assertTrue(record.isActive());
  assertTrue(record.isValid());
  Thread.sleep(5000);
  assertEquals(0,cmap.size());
  assertTrue(cmap.evict(newEvictRequest(dKey)));
  assertTrue(cmap.shouldPurgeRecord(record,Clock.currentTimeMillis() + 10000));
  cmap.removeAndPurgeRecord(record);
  assertEquals(0,cmap.mapRecords.size());
  assertEquals(0,cmap.size());
  assertEquals(0,cmap.mapIndexService.size());
  node.connectionManager.shutdown();
}
