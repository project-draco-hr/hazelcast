{
  int[][] partitionTable=new int[partitions.length][InternalPartition.MAX_REPLICA_COUNT];
  Map<Address,Integer> addressIndexes=addressToIndexMap();
  List<String> unmatchedAddresses=new LinkedList<String>();
  for (  InternalPartition partition : partitions) {
    int[] indexes=partitionTable[partition.getPartitionId()];
    for (int replicaIndex=0; replicaIndex < InternalPartition.MAX_REPLICA_COUNT; replicaIndex++) {
      Address address=partition.getReplicaAddress(replicaIndex);
      if (address == null) {
        indexes[replicaIndex]=-1;
      }
 else {
        Integer knownIndex=addressIndexes.get(address);
        if (knownIndex == null && replicaIndex == 0) {
          unmatchedAddresses.add(address + " -> " + partition);
        }
        if (knownIndex == null) {
          indexes[replicaIndex]=-1;
        }
 else {
          indexes[replicaIndex]=knownIndex;
        }
      }
    }
  }
  if (logger.isFineEnabled() && !unmatchedAddresses.isEmpty()) {
    logger.fine("Unknown owner addresses in partition state! " + "(Probably they have recently joined to or left the cluster.) " + unmatchedAddresses);
  }
  return partitionTable;
}
