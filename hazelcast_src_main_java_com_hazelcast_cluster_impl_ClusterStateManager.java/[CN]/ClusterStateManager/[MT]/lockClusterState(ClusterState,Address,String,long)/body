{
  Preconditions.checkNotNull(newState);
  clusterServiceLock.lock();
  try {
    if (newState != ClusterState.ACTIVE && node.getPartitionService().hasOnGoingMigrationLocal()) {
      throw new IllegalStateException("Still have pending migration/replication tasks, " + "cannot lock cluster state! New state: " + newState + ", current state: "+ getState());
    }
    final ClusterStateLock currentLock=getStateLock();
    if (!currentLock.allowsLock(txnId)) {
      throw new TransactionException("Locking failed for " + initiator + ", tx: "+ txnId+ ", current state: "+ toString());
    }
    stateLockRef.set(new ClusterStateLock(initiator,txnId,leaseTime));
  }
  finally {
    clusterServiceLock.unlock();
  }
}
