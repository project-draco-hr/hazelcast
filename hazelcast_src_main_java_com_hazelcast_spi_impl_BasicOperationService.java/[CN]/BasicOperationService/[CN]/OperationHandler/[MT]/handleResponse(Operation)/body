{
  boolean returnsResponse=op.returnsResponse();
  Object response=null;
  if (op instanceof BackupAwareOperation) {
    BackupAwareOperation backupAwareOp=(BackupAwareOperation)op;
    int syncBackupCount=0;
    if (backupAwareOp.shouldBackup()) {
      syncBackupCount=new OperationBackupHandler(backupAwareOp).backup();
    }
    if (returnsResponse) {
      response=new NormalResponse(op.getResponse(),op.getCallId(),syncBackupCount,op.isUrgent());
    }
  }
  if (returnsResponse) {
    if (response == null) {
      response=op.getResponse();
    }
    ResponseHandler responseHandler=op.getResponseHandler();
    if (responseHandler == null) {
      throw new IllegalStateException("ResponseHandler should not be null!");
    }
    responseHandler.sendResponse(response);
  }
}
