{
  final HazelcastException response;
  if (active) {
    ((ClientPartitionServiceImpl)client.getClientPartitionService()).refreshPartitions();
    response=new TargetDisconnectedException(connection.getRemoteEndpoint());
  }
 else {
    response=new HazelcastException("Client is shutting down!!!");
  }
  final ConcurrentMap<Integer,ClientCallFuture> callIdMap=connectionCallMap.remove(connection);
  final ConcurrentMap<Integer,ClientCallFuture> eventHandlerMap=connectionEventHandlerMap.remove(connection);
  if (callIdMap != null) {
    for (    Map.Entry<Integer,ClientCallFuture> entry : callIdMap.entrySet()) {
      if (eventHandlerMap != null) {
        eventHandlerMap.remove(entry.getKey());
      }
      entry.getValue().notify(response);
    }
    callIdMap.clear();
  }
  if (eventHandlerMap != null) {
    for (    ClientCallFuture future : eventHandlerMap.values()) {
      future.notify(response);
    }
    eventHandlerMap.clear();
  }
}
