{
  final CountDownLatch latch=new CountDownLatch(1);
  final AtomicReference<Protocol> result=new AtomicReference<Protocol>();
  if ((System.currentTimeMillis() - connection.getLastRead()) > connectionTimeout / 2) {
    Thread thread=new Thread(new Runnable(){
      @Override public void run(){
        try {
          writer.write(connection,ping);
          writer.flush(connection);
          Protocol pong=reader.read(connection);
          result.set(pong);
          latch.countDown();
        }
 catch (        IOException e) {
          e.printStackTrace();
        }
      }
    }
,"heartbeat" + connection.getAddress());
    thread.start();
    try {
      latch.await(connectionTimeout,TimeUnit.MILLISECONDS);
      return Command.OK.equals(result.get().command);
    }
 catch (    InterruptedException e) {
      return false;
    }
  }
 else   return true;
}
