{
  lock.lock();
  try {
    if (!node.isActive() || !node.joined()) {
      return;
    }
    final Address sender=partitionState.getEndpoint();
    final Address master=node.getMasterAddress();
    if (node.isMaster()) {
      logger.log(Level.WARNING,"This is the master node and received a PartitionRuntimeState from " + sender + ". Ignoring incoming state! ");
      return;
    }
 else {
      if (sender == null || !sender.equals(master)) {
        if (node.clusterService.getMember(sender) == null) {
          logger.log(Level.SEVERE,"Received a ClusterRuntimeState from an unknown member!" + " => Sender: " + sender + ", Master: "+ master+ "! ");
          return;
        }
 else {
          logger.log(Level.WARNING,"Received a ClusterRuntimeState, but its sender doesn't seem master!" + " => Sender: " + sender + ", Master: "+ master+ "! "+ "(Ignore if master node has changed recently.)");
        }
      }
    }
    final Set<Address> unknownAddresses=new HashSet<Address>();
    PartitionView[] newPartitions=partitionState.getPartitions();
    for (    PartitionView newPartition : newPartitions) {
      PartitionImpl currentPartition=partitions[newPartition.getPartitionId()];
      for (int index=0; index < PartitionImpl.MAX_REPLICA_COUNT; index++) {
        Address address=newPartition.getReplicaAddress(index);
        if (address != null && getMember(address) == null) {
          if (logger.isLoggable(Level.FINEST)) {
            logger.log(Level.FINEST,"Unknown " + address + " is found in partition table sent from master "+ sender+ ". Probably it's already left the cluster. Partition: "+ newPartition);
          }
          unknownAddresses.add(address);
        }
      }
      currentPartition.setOwner(newPartition.getOwner());
    }
    if (!unknownAddresses.isEmpty()) {
      StringBuilder s=new StringBuilder("Following unknown addresses are found in partition table").append(" sent from master[").append(sender).append("].").append(" (Probably they have recently joined to or left the cluster.)").append(" {");
      for (      Address address : unknownAddresses) {
        s.append("\n\t").append(address);
      }
      s.append("\n}");
      logger.log(Level.WARNING,s.toString());
    }
    Collection<MigrationInfo> completedMigrations=partitionState.getCompletedMigrations();
    for (    MigrationInfo completedMigration : completedMigrations) {
      addCompletedMigration(completedMigration);
      finalizeActiveMigration(completedMigration);
    }
    if (!activeMigrations.isEmpty()) {
      final MemberImpl masterMember=getMasterMember();
      rollbackActiveMigrationsFromPreviousMaster(masterMember.getUuid());
    }
    for (    PartitionView newPartition : newPartitions) {
      PartitionImpl currentPartition=partitions[newPartition.getPartitionId()];
      currentPartition.setPartitionInfo(newPartition);
    }
    stateVersion.set(partitionState.getVersion());
    initialized=true;
  }
  finally {
    lock.unlock();
  }
}
