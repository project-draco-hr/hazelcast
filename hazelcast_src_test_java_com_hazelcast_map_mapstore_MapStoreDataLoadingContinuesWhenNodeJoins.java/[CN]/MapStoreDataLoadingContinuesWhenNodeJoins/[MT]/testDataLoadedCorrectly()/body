{
  final Config config=new XmlConfigBuilder().build();
  config.setProperty("hazelcast.logging.type","log4j");
  config.setProperty("hazelcast.jmx","false");
  MapConfig mapConfig=config.getMapConfig(mapName);
  final InMemoryMapStore store=new InMemoryMapStore(false,300,false);
  store.preload(preloadSize);
  MapStoreConfig mapStoreConfig=new MapStoreConfig();
  mapStoreConfig.setEnabled(true);
  mapStoreConfig.setInitialLoadMode(InitialLoadMode.LAZY);
  mapStoreConfig.setWriteDelaySeconds(writeDelaySeconds);
  mapStoreConfig.setClassName(null);
  mapStoreConfig.setImplementation(store);
  mapConfig.setMapStoreConfig(mapStoreConfig);
  final TestHazelcastInstanceFactory factory=createHazelcastInstanceFactory(2);
  Thread thread1=new Thread(new Runnable(){
    @Override public void run(){
      HazelcastInstance hcInstance=factory.newHazelcastInstance(config);
      try {
        IMap<String,String> map=hcInstance.getMap(mapName);
        int size=map.size();
        mapSize.set(size);
      }
  finally {
        hcInstance.getLifecycleService().shutdown();
      }
    }
  }
,"Thread 1");
  thread1.start();
  sleep(10000,true);
  Thread thread2=new Thread(new Runnable(){
    @Override public void run(){
      HazelcastInstance hcInstance=factory.newHazelcastInstance(config);
      try {
        hcInstance.getMap(mapName);
        sleep(20000,true);
      }
  finally {
        hcInstance.getLifecycleService().shutdown();
      }
    }
  }
,"Thread 2");
  if (simulateSecondNode) {
    thread2.start();
  }
  thread1.join();
  if (simulateSecondNode) {
    thread2.join();
  }
  if (mapSize.get() != preloadSize) {
    fail("Not all data loaded. actual size = " + mapSize.get() + " , expected size = "+ preloadSize);
  }
}
