{
  final MutableInteger lostCount=new MutableInteger();
  final MutableInteger migrationCount=new MutableInteger();
  final List<Queue<MigrationInfo>> migrations=new ArrayList<Queue<MigrationInfo>>();
  for (int partitionId=0; partitionId < newState.length; partitionId++) {
    InternalPartitionImpl currentPartition=partitionStateManager.getPartitionImpl(partitionId);
    Address[] newReplicas=newState[partitionId];
    final MigrationCollector migrationCollector=new MigrationCollector(currentPartition,migrationCount,lostCount);
    migrationPlanner.planMigrations(currentPartition.getReplicaAddresses(),newReplicas,migrationCollector);
    migrations.add(migrationCollector.migrations);
  }
  scheduleMigrations(migrations);
  logMigrationStatistics(migrationCount.value,lostCount.value);
}
