{
  int partitionId=getPartitionId();
  InternalPartitionService partitionService=getService();
  long[] versions=partitionService.getPartitionReplicaVersions(partitionId);
  versions=Arrays.copyOf(versions,InternalPartition.MAX_BACKUP_COUNT);
  int replicaIndex=getReplicaIndex();
  versions[replicaIndex - 1]=InternalPartition.SYNC_WAITING;
  ILogger logger=getLogger();
  if (logger.isFinestEnabled()) {
    logger.finest("SYNC_WAITING flag is set. partitionId=" + partitionId + " replicaIndex="+ replicaIndex+ " replicaVersions="+ Arrays.toString(versions)+ " reason="+ reason);
  }
  if (reason == PartitionReplicaChangeReason.ASSIGNMENT) {
    resetSyncWaitingVersionsAfterReplicaIndex(versions,replicaIndex);
    if (logger.isFinestEnabled()) {
      logger.finest("SYNC_WAITING flags after replica index are reset. partitionId=" + partitionId + " replicaIndex="+ replicaIndex+ " replicaVersions="+ Arrays.toString(versions));
    }
  }
  partitionService.clearPartitionReplicaVersions(partitionId);
  partitionService.setPartitionReplicaVersions(partitionId,versions,replicaIndex);
}
