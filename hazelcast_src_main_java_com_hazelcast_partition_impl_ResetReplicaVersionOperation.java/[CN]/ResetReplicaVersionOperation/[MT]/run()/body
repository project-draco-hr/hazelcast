{
  int partitionId=getPartitionId();
  InternalPartitionService partitionService=getService();
  long[] versions=partitionService.getPartitionReplicaVersions(partitionId);
  versions=Arrays.copyOf(versions,InternalPartition.MAX_BACKUP_COUNT);
  final int replicaIndex=getReplicaIndex();
  final boolean setWaitingSyncFlag=!initialAssignment;
  if (setWaitingSyncFlag) {
    versions[replicaIndex - 1]=InternalPartition.SYNC_WAITING;
    if (getLogger().isFinestEnabled()) {
      getLogger().finest("SYNC_WAITING flag is set. partitionId=" + partitionId + " replicaIndex="+ replicaIndex+ " replicaVersions="+ Arrays.toString(versions));
    }
    if (reason == PartitionReplicaChangeReason.ASSIGNMENT) {
      resetSyncWaitingVersionsAfterReplicaIndex(versions,replicaIndex);
      if (getLogger().isFinestEnabled()) {
        getLogger().finest("SYNC_WAITING flags after replica index are reset. partitionId=" + partitionId + " replicaIndex="+ replicaIndex+ " replicaVersions="+ Arrays.toString(versions));
      }
    }
  }
  partitionService.clearPartitionReplicaVersions(partitionId);
  partitionService.setPartitionReplicaVersions(partitionId,versions,replicaIndex);
}
