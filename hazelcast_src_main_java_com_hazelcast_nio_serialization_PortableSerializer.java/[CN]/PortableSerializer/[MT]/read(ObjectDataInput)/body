{
  if (!(in instanceof BufferObjectDataInput)) {
    throw new IllegalArgumentException("ObjectDataInput must be instance of BufferObjectDataInput!");
  }
  final ContextAwareDataInput ctxIn=(ContextAwareDataInput)in;
  final int factoryId=ctxIn.getFactoryId();
  final int dataClassId=ctxIn.getDataClassId();
  final int dataVersion=ctxIn.getDataVersion();
  final PortableFactory portableFactory=factories.get(factoryId);
  if (portableFactory == null) {
    throw new HazelcastSerializationException("Could not find PortableFactory for factoryId: " + factoryId);
  }
  final Portable portable=portableFactory.create(dataClassId);
  if (portable == null) {
    throw new HazelcastSerializationException("Could not create Portable for class-id: " + dataClassId);
  }
  final PortableReader reader;
  final ClassDefinition cd;
  if (context.getVersion() == dataVersion) {
    cd=context.lookup(factoryId,dataClassId);
    reader=new DefaultPortableReader(this,(BufferObjectDataInput)in,cd);
  }
 else {
    cd=context.lookup(factoryId,dataClassId,dataVersion);
    reader=new MorphingPortableReader(this,(BufferObjectDataInput)in,cd);
  }
  portable.readPortable(reader);
  return portable;
}
