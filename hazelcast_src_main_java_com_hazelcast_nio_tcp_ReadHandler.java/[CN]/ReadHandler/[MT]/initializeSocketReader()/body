{
  if (socketReader == null) {
    final ByteBuffer protocolBuffer=ByteBuffer.allocate(3);
    int readBytes=socketChannel.read(protocolBuffer);
    if (readBytes == -1) {
      throw new EOFException("Could not read protocol type!");
    }
    if (readBytes == 0 && connectionManager.isSSLEnabled()) {
      return;
    }
    if (!protocolBuffer.hasRemaining()) {
      String protocol=bytesToString(protocolBuffer.array());
      WriteHandler writeHandler=connection.getWriteHandler();
      if (Protocols.CLUSTER.equals(protocol)) {
        configureBuffers(connectionManager.socketReceiveBufferSize);
        connection.setType(ConnectionType.MEMBER);
        writeHandler.setProtocol(Protocols.CLUSTER);
        socketReader=new SocketPacketReader(connection);
      }
 else       if (Protocols.CLIENT_BINARY.equals(protocol)) {
        configureBuffers(connectionManager.socketClientReceiveBufferSize);
        writeHandler.setProtocol(Protocols.CLIENT_BINARY);
        socketReader=new SocketClientDataReader(connection);
      }
 else       if (Protocols.CLIENT_BINARY_NEW.equals(protocol)) {
        configureBuffers(connectionManager.socketClientReceiveBufferSize);
        writeHandler.setProtocol(Protocols.CLIENT_BINARY_NEW);
        socketReader=new SocketClientMessageReader(connection,socketChannel);
      }
 else {
        configureBuffers(connectionManager.socketClientReceiveBufferSize);
        writeHandler.setProtocol(Protocols.TEXT);
        inputBuffer.put(protocolBuffer.array());
        socketReader=new SocketTextReader(connection);
        connection.getConnectionManager().incrementTextConnections();
      }
    }
    if (socketReader == null) {
      throw new IOException("Could not initialize SocketReader!");
    }
  }
}
