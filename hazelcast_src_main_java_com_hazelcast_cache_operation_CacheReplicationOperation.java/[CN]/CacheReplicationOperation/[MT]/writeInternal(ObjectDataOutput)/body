{
  super.writeInternal(out);
  int count=source.size();
  out.writeInt(count);
  if (count > 0) {
    long now=Clock.currentTimeMillis();
    for (    Map.Entry<String,Map<Data,CacheRecord>> entry : source.entrySet()) {
      Map<Data,CacheRecord> cacheMap=entry.getValue();
      int subCount=cacheMap.size();
      out.writeInt(subCount);
      if (subCount > 0) {
        out.writeUTF(entry.getKey());
        for (        Map.Entry<Data,CacheRecord> e : cacheMap.entrySet()) {
          final Data key=e.getKey();
          final CacheRecord record=e.getValue();
          final long expirationTime=record.getExpirationTime();
          if (expirationTime > now) {
            key.writeData(out);
            out.writeObject(record);
          }
          subCount--;
        }
        if (subCount != 0) {
          throw new AssertionError("Cache iteration error, count is not zero!" + subCount);
        }
      }
    }
  }
}
