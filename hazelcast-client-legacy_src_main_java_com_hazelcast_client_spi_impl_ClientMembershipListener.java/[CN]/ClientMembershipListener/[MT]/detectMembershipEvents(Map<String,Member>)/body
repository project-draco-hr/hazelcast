{
  final List<MembershipEvent> events=new LinkedList<MembershipEvent>();
  final Set<Member> eventMembers=Collections.unmodifiableSet(new LinkedHashSet<Member>(members));
  final List<Member> newMembers=new LinkedList<Member>();
  for (  Member member : members) {
    final Member former=prevMembers.remove(member.getUuid());
    if (former == null) {
      newMembers.add(member);
    }
  }
  for (  Member member : prevMembers.values()) {
    events.add(new MembershipEvent(client.getCluster(),member,MembershipEvent.MEMBER_REMOVED,eventMembers));
    Address address=member.getAddress();
    if (clusterService.getMember(address) == null) {
      final Connection connection=connectionManager.getConnection(address);
      if (connection != null) {
        connectionManager.destroyConnection(connection);
      }
    }
  }
  for (  Member member : newMembers) {
    events.add(new MembershipEvent(client.getCluster(),member,MembershipEvent.MEMBER_ADDED,eventMembers));
  }
  return events;
}
