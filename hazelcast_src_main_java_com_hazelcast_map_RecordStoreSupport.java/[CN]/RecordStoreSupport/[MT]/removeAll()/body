{
  checkIfLoaded();
  resetSizeEstimator();
  final Collection<Data> locks=lockStore != null ? lockStore.getLockedKeys() : Collections.<Data>emptySet();
  final Map<Data,Record> lockRecords=new HashMap<Data,Record>(locks.size());
  for (  Data key : locks) {
    Record record=records.get(key);
    if (record != null) {
      lockRecords.put(key,record);
      updateSizeEstimator(calculateRecordSize(record));
    }
  }
  Set<Data> keysToDelete=records.keySet();
  keysToDelete.removeAll(lockRecords.keySet());
  final MapStoreWrapper store=mapContainer.getStore();
  Set<Object> keysObject=new HashSet<Object>();
  for (  Data key : keysToDelete) {
    removeIndex(key);
    keysObject.add(mapService.toObject(key));
  }
  if (store != null) {
    store.deleteAll(keysObject);
    toBeRemovedKeys.clear();
  }
  records.clear();
  records.putAll(lockRecords);
}
