{
  this.partitionCount=node.groupProperties.PARTITION_COUNT.getInteger();
  this.node=node;
  this.nodeEngine=node.nodeEngine;
  this.logger=node.getLogger(InternalPartitionService.class);
  partitionStateSyncTimeoutHandler=logAllExceptions(logger,EXCEPTION_MSG_PARTITION_STATE_SYNC_TIMEOUT,Level.FINEST);
  this.partitions=new InternalPartitionImpl[partitionCount];
  PartitionListener partitionListener=new LocalPartitionListener(this,node.getThisAddress());
  for (int i=0; i < partitionCount; i++) {
    this.partitions[i]=new InternalPartitionImpl(i,partitionListener,node.getThisAddress());
  }
  replicaVersions=new PartitionReplicaVersions[partitionCount];
  for (int i=0; i < replicaVersions.length; i++) {
    replicaVersions[i]=new PartitionReplicaVersions(i);
  }
  memberGroupFactory=MemberGroupFactoryFactory.newMemberGroupFactory(node.getConfig().getPartitionGroupConfig());
  partitionStateGenerator=new PartitionStateGeneratorImpl();
  long interval=node.groupProperties.PARTITION_MIGRATION_INTERVAL.getLong();
  partitionMigrationInterval=interval > 0 ? TimeUnit.SECONDS.toMillis(interval) : 0;
  partitionMigrationTimeout=TimeUnit.SECONDS.toMillis(node.groupProperties.PARTITION_MIGRATION_TIMEOUT.getLong());
  migrationThread=new MigrationThread(node);
  proxy=new PartitionServiceProxy(this);
  ExecutionService executionService=nodeEngine.getExecutionService();
  ScheduledExecutorService scheduledExecutor=executionService.getDefaultScheduledExecutor();
  replicaSyncScheduler=EntryTaskSchedulerFactory.newScheduler(scheduledExecutor,new ReplicaSyncEntryProcessor(this),ScheduleType.POSTPONE);
  replicaSyncRequests=new AtomicReferenceArray<ReplicaSyncInfo>(partitionCount);
  long maxMigrationDelayMs=calculateMaxMigrationDelayOnMemberRemoved();
  long minMigrationDelayMs=calculateMigrationDelayOnMemberRemoved(maxMigrationDelayMs);
  this.delayedResumeMigrationTrigger=new CoalescingDelayedTrigger(executionService,minMigrationDelayMs,maxMigrationDelayMs,new Runnable(){
    @Override public void run(){
      resumeMigration();
    }
  }
);
  long definedBackupSyncCheckInterval=node.groupProperties.PARTITION_BACKUP_SYNC_INTERVAL.getInteger();
  backupSyncCheckInterval=definedBackupSyncCheckInterval > 0 ? definedBackupSyncCheckInterval : 1;
  maxParallelReplications=node.groupProperties.PARTITION_MAX_PARALLEL_REPLICATIONS.getInteger();
  replicaSyncProcessLock=new Semaphore(maxParallelReplications);
  nodeEngine.getMetricsRegistry().scanAndRegister(this,"partitions");
}
