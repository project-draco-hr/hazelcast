{
  final Operation op=(Operation)backupAwareOp;
  final boolean returnsResponse=op.returnsResponse();
  final int maxBackups=Math.min(node.getClusterService().getSize(),PartitionInfo.MAX_REPLICA_COUNT) - 1;
  int syncBackupCount=backupAwareOp.getSyncBackupCount() > 0 ? Math.min(maxBackups,backupAwareOp.getSyncBackupCount()) : 0;
  int asyncBackupCount=(backupAwareOp.getAsyncBackupCount() > 0 && maxBackups > syncBackupCount) ? Math.min(maxBackups - syncBackupCount,backupAwareOp.getAsyncBackupCount()) : 0;
  if (!returnsResponse) {
    asyncBackupCount+=syncBackupCount;
    syncBackupCount=0;
  }
  final int totalBackupCount=syncBackupCount + asyncBackupCount;
  if (totalBackupCount > 0) {
    final String serviceName=op.getServiceName();
    final int partitionId=op.getPartitionId();
    final PartitionServiceImpl partitionService=(PartitionServiceImpl)nodeEngine.getPartitionService();
    final long[] replicaVersions=partitionService.incrementPartitionReplicaVersions(partitionId,totalBackupCount);
    final PartitionInfo partitionInfo=partitionService.getPartitionInfo(partitionId);
    for (int replicaIndex=1; replicaIndex <= totalBackupCount; replicaIndex++) {
      final Operation backupOp=backupAwareOp.getBackupOperation();
      if (backupOp == null) {
        throw new IllegalArgumentException("Backup operation should not be null!");
      }
      backupOp.setPartitionId(partitionId).setReplicaIndex(replicaIndex).setServiceName(serviceName);
      final Backup backup=new Backup(backupOp,op.getCallerAddress(),replicaVersions,replicaIndex <= syncBackupCount);
      backup.setPartitionId(partitionId).setReplicaIndex(replicaIndex).setServiceName(serviceName).setCallerUuid(nodeEngine.getLocalMember().getUuid());
      OperationAccessor.setCallId(backup,op.getCallId());
      final Address target=partitionInfo.getReplicaAddress(replicaIndex);
      if (target != null) {
        if (target.equals(node.getThisAddress())) {
          throw new IllegalStateException("Normally shouldn't happen!!");
        }
 else {
          send(backup,target);
        }
      }
 else {
        final RemoteCallKey key=new RemoteCallKey(op.getCallerAddress(),op.getCallId());
        if (logger.isLoggable(Level.INFO)) {
          logger.log(Level.INFO,"Scheduling -> " + backup);
        }
        backupScheduler.schedule(500,key,new ScheduledBackup(backup,partitionId,replicaIndex));
      }
    }
  }
  return syncBackupCount;
}
