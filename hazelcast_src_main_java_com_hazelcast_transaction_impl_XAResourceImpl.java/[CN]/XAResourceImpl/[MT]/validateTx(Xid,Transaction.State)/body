{
  final Transaction tx=getTransaction();
  if (this.xid == null) {
    final XAException xaException=new XAException(XAException.XAER_NOTA);
    logger.severe("Not yet started!!! xid: " + xid,xaException);
    throw xaException;
  }
  if (!this.xid.equals(xid)) {
    final XAException xaException=new XAException(XAException.XAER_DUPID);
    logger.severe("Duplicate xid: " + xid + ", this.xid: "+ this.xid,xaException);
    throw xaException;
  }
  final Transaction.State txState=tx.getState();
switch (state) {
case ACTIVE:
    if (txState != Transaction.State.ACTIVE) {
      final XAException xaException=new XAException(XAException.XAER_NOTA);
      logger.severe("Transaction is not active!!! state: " + txState,xaException);
      throw xaException;
    }
  break;
case PREPARED:
if (txState != Transaction.State.PREPARED) {
  final XAException xaException=new XAException(XAException.XAER_INVAL);
  logger.severe("Transaction is not prepared!!! state: " + txState,xaException);
  throw xaException;
}
break;
case NO_TXN:
break;
}
}
