{
  if (request.operation == OP_CMAP_PUT_IF_ABSENT) {
    Record record=recordExist(request);
    if (record != null && record.getValue() != null) {
      Data valueCopy=ThreadContext.get().hardCopy(record.getValue());
      request.response=valueCopy;
      return;
    }
  }
 else   if (request.operation == OP_CMAP_REPLACE_IF_NOT_NULL) {
    Record record=recordExist(request);
    if (record == null || record.getValue() == null) {
      request.response=null;
      return;
    }
  }
  if (!testLock(request)) {
    if (request.hasEnoughTimeToSchedule()) {
      Record record=ensureRecord(request);
      request.scheduled=true;
      final Request reqScheduled=(request.local) ? request : request.hardCopy();
      record.addScheduledAction(new ScheduledAction(request){
        @Override public boolean consume(){
          CMap cmap=getMap(reqScheduled.name);
          Data oldValue=cmap.put(reqScheduled);
          reqScheduled.response=oldValue;
          reqScheduled.key=null;
          reqScheduled.value=null;
          returnScheduledAsSuccess(reqScheduled);
          return true;
        }
      }
);
    }
 else {
      request.response=null;
    }
  }
 else {
    CMap cmap=getMap(request.name);
    Data oldValue=cmap.put(request);
    request.response=oldValue;
  }
}
