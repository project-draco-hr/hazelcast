{
  Config c1=new Config();
  c1.getNetworkConfig().getJoin().getMulticastConfig().setEnabled(multicast);
  c1.getNetworkConfig().getJoin().getTcpIpConfig().setEnabled(!multicast);
  c1.getNetworkConfig().getJoin().getTcpIpConfig().addMember("127.0.0.1");
  c1.getNetworkConfig().getInterfaces().clear();
  c1.getNetworkConfig().getInterfaces().addInterface("127.0.0.1");
  c1.getNetworkConfig().getInterfaces().setEnabled(true);
  Config c2=new Config();
  c2.getNetworkConfig().getJoin().getMulticastConfig().setEnabled(multicast);
  c2.getNetworkConfig().getJoin().getTcpIpConfig().setEnabled(!multicast);
  c2.getNetworkConfig().getJoin().getTcpIpConfig().addMember("127.0.0.1");
  c2.getNetworkConfig().getInterfaces().clear();
  c2.getNetworkConfig().getInterfaces().addInterface("127.0.0.1");
  c2.getNetworkConfig().getInterfaces().setEnabled(true);
  c1.getGroupConfig().setName("differentGroup");
  c2.getGroupConfig().setName("sameGroup");
  c1.setProperty(GroupProperties.PROP_MERGE_FIRST_RUN_DELAY_SECONDS,"5");
  c1.setProperty(GroupProperties.PROP_MERGE_NEXT_RUN_DELAY_SECONDS,"3");
  c2.setProperty(GroupProperties.PROP_MERGE_FIRST_RUN_DELAY_SECONDS,"5");
  c2.setProperty(GroupProperties.PROP_MERGE_NEXT_RUN_DELAY_SECONDS,"3");
  HazelcastInstance h1=Hazelcast.newHazelcastInstance(c1);
  HazelcastInstance h2=Hazelcast.newHazelcastInstance(c2);
  LifecycleCountingListener l=new LifecycleCountingListener();
  h2.getLifecycleService().addLifecycleListener(l);
  int size=500;
  for (int i=0; i < size; i++) {
    h2.getMap("default").put(i,"value" + i);
    h2.getMultiMap("default").put(i,"value" + i);
    h2.getMultiMap("default").put(i,"value0" + i);
  }
  for (int i=100; i < size + 100; i++) {
    h1.getMap("default").put(i,"value" + i);
    h1.getMultiMap("default").put(i,"value" + i);
    h1.getMultiMap("default").put(i,"value0" + i);
  }
  assertEquals(size,h2.getMap("default").size());
  assertEquals(2 * size,h2.getMultiMap("default").size());
  assertEquals(size,h1.getMap("default").size());
  assertEquals(2 * size,h1.getMultiMap("default").size());
  assertEquals(1,h1.getCluster().getMembers().size());
  assertEquals(1,h2.getCluster().getMembers().size());
  Thread.sleep(2000);
  c1.getGroupConfig().setName("sameGroup");
  assertTrue(l.waitFor(LifecycleState.MERGED,40));
  assertEquals(1,l.getCount(LifecycleState.MERGING));
  assertEquals(1,l.getCount(LifecycleState.RESTARTING));
  assertEquals(1,l.getCount(LifecycleState.RESTARTED));
  assertEquals(1,l.getCount(LifecycleState.MERGED));
  assertEquals(2,h1.getCluster().getMembers().size());
  assertEquals(2,h2.getCluster().getMembers().size());
  Thread.sleep(2000);
  int newMapSize=size + 100;
  int newMultiMapSize=2 * newMapSize;
  assertEquals(newMapSize,h1.getMap("default").size());
  assertEquals(newMapSize,h2.getMap("default").size());
  assertEquals(newMultiMapSize,h2.getMultiMap("default").size());
  assertEquals(newMultiMapSize,h1.getMultiMap("default").size());
}
