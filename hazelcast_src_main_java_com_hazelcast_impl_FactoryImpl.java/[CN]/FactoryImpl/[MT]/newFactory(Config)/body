{
synchronized (factoryLock) {
    String name="_hzInstance_" + nextFactoryId++;
    if (config == null) {
      config=new XmlConfigBuilder().build();
    }
    FactoryImpl factory=new FactoryImpl(name,config);
    FactoryImpl old=factories.put(name,factory);
    if (old != null)     throw new RuntimeException();
    if (!jmxRegistered) {
      ManagementService.register(factory,config);
      jmxRegistered=true;
    }
    return factory;
  }
}
