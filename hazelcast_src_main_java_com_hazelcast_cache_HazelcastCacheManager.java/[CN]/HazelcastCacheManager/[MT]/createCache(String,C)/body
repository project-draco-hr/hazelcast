{
  if (isClosed()) {
    throw new IllegalStateException();
  }
  if (cacheName == null) {
    throw new NullPointerException("cacheName must not be null");
  }
  if (configuration == null) {
    throw new NullPointerException("configuration must not be null");
  }
synchronized (caches) {
    final String cacheNameWithPrefix=getCacheNameWithPrefix(cacheName);
    final CacheConfig cacheConfig=getCacheConfigLocal(cacheNameWithPrefix);
    if (cacheConfig == null) {
      final CacheConfig<K,V> newCacheConfig=createCacheConfig(cacheName,configuration);
      final boolean created=createConfigOnPartition(newCacheConfig);
      if (created) {
        createConfigOnAllMembers(newCacheConfig);
        addCacheConfigIfAbsentToLocal(newCacheConfig);
        final ICache<K,V> cacheProxy=createCacheProxy(newCacheConfig);
        caches.put(cacheNameWithPrefix,cacheProxy);
        if (newCacheConfig.isStatisticsEnabled()) {
          enableStatistics(cacheName,true);
        }
        if (newCacheConfig.isManagementEnabled()) {
          enableManagement(cacheName,true);
        }
        registerListeners(newCacheConfig,cacheProxy);
        return cacheProxy;
      }
 else {
        final CacheConfig<K,V> cacheConfigFromPartition=getCacheConfigFromPartition(cacheNameWithPrefix);
        createConfigOnAllMembers(cacheConfigFromPartition);
        addCacheConfigIfAbsentToLocal(cacheConfigFromPartition);
      }
    }
    throw new CacheException("A cache named " + cacheName + " already exists.");
  }
}
