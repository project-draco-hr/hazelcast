{
  if (!nodeEngine.isActive()) {
    remote=false;
    notify(new HazelcastInstanceNotActiveException());
    return;
  }
  final Address invTarget=getTarget();
  target=invTarget;
  invokeCount++;
  final Address thisAddress=nodeEngine.getThisAddress();
  if (invTarget == null) {
    remote=false;
    if (nodeEngine.isActive()) {
      notify(new WrongTargetException(thisAddress,null,partitionId,replicaIndex,op.getClass().getName(),serviceName));
    }
 else {
      notify(new HazelcastInstanceNotActiveException());
    }
    return;
  }
  final MemberImpl member=nodeEngine.getClusterService().getMember(invTarget);
  if (!OperationAccessor.isJoinOperation(op) && member == null) {
    notify(new TargetNotMemberException(invTarget,partitionId,op.getClass().getName(),serviceName));
    return;
  }
  if (op.getPartitionId() != partitionId) {
    notify(new IllegalStateException("Partition id of operation: " + op.getPartitionId() + " is not equal to the partition id of invocation: "+ partitionId));
    return;
  }
  if (op.getReplicaIndex() != replicaIndex) {
    notify(new IllegalStateException("Replica index of operation: " + op.getReplicaIndex() + " is not equal to the replica index of invocation: "+ replicaIndex));
    return;
  }
  final BasicOperationService operationService=(BasicOperationService)nodeEngine.operationService;
  OperationAccessor.setInvocationTime(op,nodeEngine.getClusterTime());
  remote=!thisAddress.equals(invTarget);
  if (remote) {
    final RemoteCall call=member != null ? new RemoteCall(member,this) : new RemoteCall(invTarget,this);
    final long callId=operationService.registerRemoteCall(call);
    if (op instanceof BackupAwareOperation) {
      registerBackups((BackupAwareOperation)op,callId);
    }
    OperationAccessor.setCallId(op,callId);
    boolean sent=operationService.send(op,invTarget);
    if (!sent) {
      operationService.deregisterRemoteCall(callId);
      operationService.deregisterBackupCall(callId);
      notify(new RetryableIOException("Packet not sent to -> " + invTarget));
    }
  }
 else {
    if (op instanceof BackupAwareOperation) {
      final long callId=operationService.newCallId();
      registerBackups((BackupAwareOperation)op,callId);
      OperationAccessor.setCallId(op,callId);
    }
    ResponseHandlerFactory.setLocalResponseHandler(op,this);
    if (operationService.isAllowedToRunInCurrentThread(op)) {
      operationService.runOperation(op);
    }
 else {
      operationService.executeOperation(op);
    }
  }
}
