{
  FailAwareMapStore testMapStore=new FailAwareMapStore();
  Config config=newConfig(testMapStore,2);
  HazelcastInstance h1=Hazelcast.newHazelcastInstance(config);
  IMap map=h1.getMap("default");
  assertEquals(0,map.size());
  CMap cmap=getCMap(h1,"default");
  assertEquals(0,testMapStore.db.size());
  testMapStore.setFail(true);
  map.put("1","value1");
  Thread.sleep(3000);
  BlockingQueue listener=new LinkedBlockingQueue();
  testMapStore.addListener(listener);
  cmap.startCleanup(false);
  assertNotNull(listener.poll(20,TimeUnit.SECONDS));
  assertEquals(1,map.size());
  assertEquals(0,testMapStore.db.size());
  testMapStore.setFail(false);
  cmap.startCleanup(false);
  assertNotNull(listener.poll(20,TimeUnit.SECONDS));
  assertEquals(1,testMapStore.db.size());
  assertEquals("value1",testMapStore.db.get("1"));
}
