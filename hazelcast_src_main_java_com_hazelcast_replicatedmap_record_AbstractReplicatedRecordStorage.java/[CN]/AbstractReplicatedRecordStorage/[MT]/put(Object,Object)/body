{
  V oldValue=null;
synchronized (getMutex(key)) {
    final ReplicatedRecord old=storage.get(key);
    final Vector vector;
    if (old == null) {
      vector=new Vector();
      ReplicatedRecord<K,V> record=new ReplicatedRecord(key,value,vector,localMemberHash);
      storage.put((K)key,record);
    }
 else {
      oldValue=(V)old.getValue();
      vector=old.getVector();
      storage.get(key).setValue((V)value,localMemberHash);
    }
    incrementClock(vector);
    publishReplicatedMessage(new ReplicationMessage(name,key,value,vector,localMember,localMemberHash));
  }
  return oldValue;
}
