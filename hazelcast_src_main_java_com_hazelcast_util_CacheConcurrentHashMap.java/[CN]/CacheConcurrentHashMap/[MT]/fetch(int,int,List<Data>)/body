{
  final long now=Clock.currentTimeMillis();
  int nextTableIndex;
  final Segment<K,V> segment=segments[0];
  HashEntry<K,V>[] currentTable=segment.table;
  if (tableIndex >= 0 && tableIndex < segment.table.length) {
    nextTableIndex=tableIndex;
  }
 else {
    nextTableIndex=currentTable.length - 1;
  }
  int counter=0;
  while (nextTableIndex >= 0 && counter < size) {
    HashEntry<K,V> nextEntry=currentTable[nextTableIndex--];
    while (nextEntry != null) {
      if (nextEntry.key() != null) {
        final V value=nextEntry.value();
        final boolean isExpired=(value instanceof Expirable) && ((Expirable)value).isExpiredAt(now);
        if (!isExpired) {
          keys.add((Data)nextEntry.key());
          counter++;
        }
      }
      nextEntry=nextEntry.next;
    }
  }
  return nextTableIndex;
}
