{
  if (req.value == null) {
    req.value=new Data();
  }
  if (req.operation == CONCURRENT_MAP_PUT_IF_ABSENT) {
    Record record=recordExist(req);
    if (record != null && record.getValue() != null) {
      return doHardCopy(record.getValue());
    }
  }
 else   if (req.operation == CONCURRENT_MAP_REPLACE_IF_NOT_NULL) {
    Record record=recordExist(req);
    if (record == null || record.getValue() == null) {
      return null;
    }
  }
  Record record=getRecord(req.key);
  Data oldValue=null;
  if (record == null) {
    record=createNewRecord(req.key,req.value);
    req.key=null;
  }
 else {
    markAsActive(record);
    if (!record.isValid()) {
      record.setExpirationTime(ttl);
    }
    oldValue=record.getValue();
    record.setValue(req.value);
    record.version++;
    touch(record);
    record.setLastUpdated();
  }
  req.version=record.version;
  req.longValue=record.copyCount;
  req.value=null;
  if (oldValue == null) {
    fireMapEvent(mapListeners,name,EntryEvent.TYPE_ADDED,record);
  }
 else {
    fireMapEvent(mapListeners,name,EntryEvent.TYPE_UPDATED,record);
  }
  if (req.txnId != -1) {
    record.unlock();
  }
  markAsDirty(record);
  return oldValue;
}
