{
  ThreadContext threadContext=ThreadContext.get();
  TransactionImpl txn=threadContext.txn;
  if (txn != null && txn.getStatus() == Transaction.TXN_STATUS_ACTIVE) {
    try {
      if (!txn.has(name,key)) {
        MLock mlock=new MLock();
        boolean locked=mlock.lockAndReturnOld(name,key,DEFAULT_TXN_TIMEOUT,txn.getId());
        if (!locked)         throwCME(key);
        Object oldObject=null;
        Data oldValue=mlock.oldValue;
        if (oldValue != null) {
          oldObject=toObject(oldValue);
        }
        txn.attachPutOp(name,key,value,(oldObject == null));
        return oldObject;
      }
 else {
        return txn.attachPutOp(name,key,value,false);
      }
    }
 catch (    Exception e1) {
      e1.printStackTrace();
    }
    return null;
  }
 else {
    setLocal(operation,name,key,value,timeout,-1);
    setIndexValues(request,value);
    doOp();
    Object oldValue=getResultAsObject();
    if (oldValue instanceof AddressAwareException) {
      rethrowException(operation,(AddressAwareException)oldValue);
    }
    backup(CONCURRENT_MAP_BACKUP_PUT);
    return oldValue;
  }
}
