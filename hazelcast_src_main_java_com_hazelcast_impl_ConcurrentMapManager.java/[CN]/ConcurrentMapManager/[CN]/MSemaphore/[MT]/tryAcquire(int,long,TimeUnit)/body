{
  Boolean result=false;
  int remaining=permits;
  long elapsed=0;
  do {
    long start=System.currentTimeMillis();
    setLocal(op,MapConfig.SEMAPHORE_MAP_NAME,nameAsKey,remaining,timeUnit.convert(timeout - elapsed,TimeUnit.MILLISECONDS),0);
    request.longValue=value;
    request.caller=thisAddress;
    request.operation=SEMAPHORE_ACQUIRE;
    doOp();
    remaining=(Integer)getResultAsObject(false);
    long end=System.currentTimeMillis();
    elapsed+=end - start;
    if (remaining == 0) {
      result=true;
    }
  }
 while (remaining > 0 && (timeout > 0 && timeout > elapsed));
  if (!result) {
    tryRelease(permits - remaining,-1,TimeUnit.MILLISECONDS);
  }
  backup(SEMAPHORE_ACQUIRE);
  return result;
}
