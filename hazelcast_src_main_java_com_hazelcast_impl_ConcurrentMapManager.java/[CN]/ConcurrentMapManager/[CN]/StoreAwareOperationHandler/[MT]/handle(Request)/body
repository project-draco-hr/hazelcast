{
  CallHistory.CallerThreadState cts=node.getCallHistory().getOrCreateCallerThreadState(request.caller,request.lockThreadId);
  try {
    cts.set(request.name,request.callId,request.operation);
    CMap cmap=getOrCreateMap(request.name);
    if (cmap.isNotLocked(request) && !cmap.exceedingMapMaxSize(request)) {
      if (shouldSchedule(request)) {
        if (request.hasEnoughTimeToSchedule()) {
          schedule(request);
        }
 else {
          onNoTimeToSchedule(request);
        }
        return;
      }
      if (shouldExecuteAsync(request)) {
        executeAsync(request);
        return;
      }
      doOperation(request);
      returnResponse(request);
    }
 else {
      request.response=OBJECT_REDO;
      returnResponse(request);
    }
  }
  finally {
    if (request.scheduled) {
      cts.setScheduled();
    }
    cts.response=request.response;
  }
}
