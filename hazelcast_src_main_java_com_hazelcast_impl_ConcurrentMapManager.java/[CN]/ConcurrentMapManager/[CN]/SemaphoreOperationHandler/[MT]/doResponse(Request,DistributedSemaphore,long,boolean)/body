{
  final boolean wasScheduled=request.scheduled;
  final Record record=request.record;
  final List<ScheduledAction> scheduledActions=record.getScheduledActions();
  request.clearForResponse();
  if (changed) {
    record.setValueData(toData(semaphore));
    record.incrementVersion();
    request.version=record.getVersion();
    request.response=record.getValueData();
  }
  request.longValue=retValue;
  returnResponse(request);
  if (!wasScheduled && scheduledActions != null) {
    int remaining=scheduledActions.size();
    while (remaining-- > 0 && semaphore.getAvailable() > 0) {
      ScheduledAction sa=scheduledActions.remove(0);
      node.clusterManager.deregisterScheduledAction(sa);
      if (!sa.expired()) {
        sa.consume();
      }
 else {
        sa.onExpire();
      }
    }
  }
}
