{
  request.record=ensureRecord(request,null);
  if (request.record.getValue() == null) {
    final String name=(String)toObject(request.key);
    final SemaphoreConfig sc=node.getConfig().getSemaphoreConfig(name);
    final int configInitialPermits=sc.getInitialPermits();
    if (sc.isFactoryEnabled()) {
      node.executorManager.executeNow(new Runnable(){
        public void run(){
          try {
            initSemaphore(sc,request,name);
          }
 catch (          Exception e) {
            logger.log(Level.SEVERE,e.getMessage(),e);
          }
 finally {
            enqueueAndReturn(new Processable(){
              public void process(){
                SemaphoreOperationHandler.this.handle(request);
              }
            }
);
          }
        }
      }
);
      return;
    }
 else {
      request.record.setValue(new DistributedSemaphore(configInitialPermits));
    }
  }
  doOperation(request);
}
