{
  checkTransactionState();
  MapService service=getService();
  final MapServiceContext mapServiceContext=service.getMapServiceContext();
  final Object valueBeforeTxn=mapServiceContext.toObject(putInternal(mapServiceContext.toData(key,partitionStrategy),mapServiceContext.toData(value)));
  TxnValueWrapper currentValue=txMap.get(key);
  if (value != null) {
    TxnValueWrapper wrapper=valueBeforeTxn == null ? new TxnValueWrapper(value,TxnValueWrapper.Type.NEW) : new TxnValueWrapper(value,TxnValueWrapper.Type.UPDATED);
    txMap.put(key,wrapper);
  }
  return currentValue == null ? valueBeforeTxn : checkIfRemoved(currentValue);
}
