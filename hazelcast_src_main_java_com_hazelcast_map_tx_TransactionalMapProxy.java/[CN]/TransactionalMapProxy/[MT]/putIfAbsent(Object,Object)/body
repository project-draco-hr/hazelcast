{
  checkTransactionState();
  TxnValueWrapper wrapper=txMap.get(key);
  boolean haveTxnPast=wrapper != null;
  MapService service=getService();
  if (haveTxnPast) {
    if (wrapper.type != TxnValueWrapper.Type.REMOVED) {
      return wrapper.value;
    }
    putInternal(service.toData(key,partitionStrategy),service.toData(value));
    txMap.put(key,new TxnValueWrapper(value,TxnValueWrapper.Type.NEW));
    return null;
  }
 else {
    Data oldValue=putIfAbsentInternal(service.toData(key,partitionStrategy),service.toData(value));
    if (oldValue == null) {
      txMap.put(key,new TxnValueWrapper(value,TxnValueWrapper.Type.NEW));
    }
    return service.toObject(oldValue);
  }
}
