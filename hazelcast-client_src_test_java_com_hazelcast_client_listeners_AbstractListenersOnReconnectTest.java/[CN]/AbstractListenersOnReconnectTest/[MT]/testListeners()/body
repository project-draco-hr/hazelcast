{
  HazelcastInstance h1=factory.newHazelcastInstance();
  ClientConfig clientConfig=new ClientConfig();
  clientConfig.getNetworkConfig().setRedoOperation(true);
  clientConfig.getNetworkConfig().setConnectionAttemptLimit(Integer.MAX_VALUE);
  client=factory.newHazelcastClient(clientConfig);
  final CountDownLatch connectedLatch=new CountDownLatch(2);
  client.getLifecycleService().addLifecycleListener(new LifecycleListener(){
    @Override public void stateChanged(    LifecycleEvent event){
      connectedLatch.countDown();
    }
  }
);
  final AtomicInteger eventCount=new AtomicInteger();
  String registrationId=addListener(eventCount);
  h1.shutdown();
  factory.newHazelcastInstance();
  assertOpenEventually(connectedLatch,10);
  assertTrueEventually(new AssertTask(){
    @Override public void run() throws Exception {
      produceEvent();
      int count=eventCount.get();
      assertTrue("No events generated!",count > 0);
    }
  }
,30);
  assertTrue(removeListener(registrationId));
}
