{
  lastHandle=Clock.currentTimeMillis();
  if (!connection.live()) {
    return;
  }
  if (!initialized) {
    initialized=true;
    buffer.put(Protocols.CLIENT_BINARY.getBytes());
    buffer.put(ClientTypes.JAVA.getBytes());
    registerWrite();
  }
  if (lastWritable == null && (lastWritable=poll()) == null && buffer.position() == 0) {
    ready=true;
    return;
  }
  try {
    while (buffer.hasRemaining() && lastWritable != null) {
      boolean complete=lastWritable.writeTo(buffer);
      if (complete) {
        lastWritable=poll();
      }
 else {
        break;
      }
    }
    if (buffer.position() > 0) {
      buffer.flip();
      try {
        socketChannel.write(buffer);
      }
 catch (      Exception e) {
        lastWritable=null;
        handleSocketException(e);
        return;
      }
      if (buffer.hasRemaining()) {
        buffer.compact();
      }
 else {
        buffer.clear();
      }
    }
  }
 catch (  Throwable t) {
    logger.severe("Fatal Error at WriteHandler for endPoint: " + connection.getEndPoint(),t);
  }
 finally {
    ready=false;
    registerWrite();
  }
}
