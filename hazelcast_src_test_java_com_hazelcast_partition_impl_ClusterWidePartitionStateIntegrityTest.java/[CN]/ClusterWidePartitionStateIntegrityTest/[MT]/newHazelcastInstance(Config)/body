{
  final HazelcastInstance instance;
  if (MOCK_NETWORK) {
    instance=factory.newHazelcastInstance();
    final Node node=getNode(instance);
    FirewallingMockConnectionManager cm=(FirewallingMockConnectionManager)node.getConnectionManager();
    cm.setPacketFilter(new PartitionStatePacketFilter(node.getSerializationService(),blockedAddresses));
  }
 else {
    return HazelcastInstanceManager.newHazelcastInstance(config,null,new PartitionStateNodeContext(blockedAddresses));
  }
  return instance;
}
