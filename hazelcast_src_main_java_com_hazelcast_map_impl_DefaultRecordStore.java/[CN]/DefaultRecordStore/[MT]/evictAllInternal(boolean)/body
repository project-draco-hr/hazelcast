{
  resetSizeEstimator();
  resetAccessSequenceNumber();
  Set<Data> keysToPreserve=Collections.emptySet();
  final Map<Data,Record> recordsToPreserve=getLockedRecords(backup);
  if (!recordsToPreserve.isEmpty()) {
    keysToPreserve=recordsToPreserve.keySet();
    updateSizeEstimator(calculateRecordHeapCost(recordsToPreserve.values()));
  }
  flush(recordsToPreserve,backup);
  clearRecordsMap(recordsToPreserve);
  return keysToPreserve;
}
