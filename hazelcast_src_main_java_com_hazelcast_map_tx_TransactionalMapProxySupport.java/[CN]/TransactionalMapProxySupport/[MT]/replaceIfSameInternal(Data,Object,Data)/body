{
  VersionedValue versionedValue=lockAndGet(key,tx.getTimeoutMillis());
  if (!getService().getMapServiceContext().compare(name,oldValue,versionedValue.value)) {
    TxnUnlockOperation operation=new TxnUnlockOperation(name,key,versionedValue.version);
    tx.addTransactionLog(new MapTransactionLog(name,key,operation,versionedValue.version,tx.getOwnerUuid()));
    return false;
  }
  final TxnSetOperation op=new TxnSetOperation(name,key,newValue,versionedValue.version);
  tx.addTransactionLog(new MapTransactionLog(name,key,op,versionedValue.version,tx.getOwnerUuid()));
  return true;
}
