{
  SpinningWriteHandler writeHandler=(SpinningWriteHandler)connection.getWriteHandler();
  for (; ; ) {
    ConnectionHandlers current=connectionHandlers;
    if (current == SHUTDOWN) {
      return;
    }
    int length=current.writeHandlers.length;
    SpinningWriteHandler[] newWriteHandlers=new SpinningWriteHandler[length + 1];
    arraycopy(current.writeHandlers,0,newWriteHandlers,0,length);
    newWriteHandlers[length]=writeHandler;
    ConnectionHandlers update=new ConnectionHandlers(newWriteHandlers);
    if (CONNECTION_HANDLERS.compareAndSet(this,current,update)) {
      return;
    }
  }
}
