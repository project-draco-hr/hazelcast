{
  localMember=node.localMember;
  Collection<MemberImpl> memberList=node.clusterService.getMemberList();
  registrations=new HashMap<String,HazelcastInstanceImpl>(3);
  Set<MemberImpl> members=memberList instanceof Set ? (Set<MemberImpl>)memberList : new HashSet<MemberImpl>(memberList);
  members.remove(localMember);
  if (!members.isEmpty()) {
    final Map<MemberImpl,HazelcastInstanceImpl> map=HazelcastInstanceFactory.getInstanceImplMap();
    for (    Map.Entry<MemberImpl,HazelcastInstanceImpl> entry : map.entrySet()) {
      final MemberImpl member=entry.getKey();
      if (members.contains(member)) {
        HazelcastInstanceImpl instance=entry.getValue();
        if (instance.getLifecycleService().isRunning()) {
          final String id=instance.node.clusterService.addMembershipListener(new ShutdownMembershipListener());
          registrations.put(id,instance);
        }
      }
    }
  }
  latch=new Semaphore(0);
}
