{
  if (socketReader != null) {
    return;
  }
  int readBytes=socketChannel.read(protocolBuffer);
  if (readBytes == -1) {
    throw new EOFException("Could not read protocol type!");
  }
  if (readBytes == 0 && connectionManager.isSSLEnabled()) {
    return;
  }
  if (protocolBuffer.hasRemaining()) {
    return;
  }
  String protocol=bytesToString(protocolBuffer.array());
  WriteHandler writeHandler=connection.getWriteHandler();
  if (CLUSTER.equals(protocol)) {
    configureBuffers(ioService.getSocketReceiveBufferSize() * KILO_BYTE);
    connection.setType(MEMBER);
    writeHandler.setProtocol(CLUSTER);
    socketReader=ioService.createSocketReader(connection);
  }
 else   if (CLIENT_BINARY.equals(protocol)) {
    configureBuffers(ioService.getSocketClientReceiveBufferSize() * KILO_BYTE);
    writeHandler.setProtocol(CLIENT_BINARY);
    socketReader=new ClientPacketSocketReader(connection,ioService);
  }
 else   if (CLIENT_BINARY_NEW.equals(protocol)) {
    configureBuffers(ioService.getSocketClientReceiveBufferSize() * KILO_BYTE);
    writeHandler.setProtocol(CLIENT_BINARY_NEW);
    socketReader=new ClientMessageSocketReader(connection,ioService);
  }
 else {
    configureBuffers(ioService.getSocketReceiveBufferSize() * KILO_BYTE);
    writeHandler.setProtocol(Protocols.TEXT);
    inputBuffer.put(protocolBuffer.array());
    socketReader=new SocketTextReader(connection);
    connection.getConnectionManager().incrementTextConnections();
  }
}
