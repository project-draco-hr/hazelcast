{
  if (!connection.live())   return;
  try {
    final int readBytes=socketChannel.read(inBuffer);
    if (readBytes == -1) {
      connection.close();
      return;
    }
    if (readBytes <= 0) {
      return;
    }
  }
 catch (  final Exception e) {
    if (packet != null) {
      packet.returnToContainer();
      packet=null;
    }
    handleSocketException(e);
    return;
  }
  try {
    inBuffer.flip();
    while (true) {
      final int remaining=inBuffer.remaining();
      if (remaining <= 0) {
        inBuffer.clear();
        return;
      }
      if (packet == null) {
        if (remaining >= 12) {
          packet=obtainReadable();
          if (packet == null) {
            throw new RuntimeException("Unknown message type  from " + connection.getEndPoint());
          }
        }
 else {
          inBuffer.compact();
          return;
        }
      }
      final boolean full=packet.read(inBuffer);
      if (full) {
        packet.flipBuffers();
        packet.read();
        packet.setFromConnection(connection);
        ClusterService.get().enqueueAndReturn(packet);
        packet=null;
      }
 else {
        if (inBuffer.hasRemaining()) {
          if (DEBUG) {
            throw new RuntimeException("inbuffer has remaining " + inBuffer.remaining());
          }
        }
      }
    }
  }
 catch (  final Throwable t) {
    logger.log(Level.SEVERE,"Fatal Error at ReadHandler for endPoint: " + connection.getEndPoint(),t);
  }
 finally {
    registerOp(inSelector.selector,SelectionKey.OP_READ);
  }
}
