{
  while (inBuffer.remaining() >= 128) {
    if (cipherBuffer.position() > 0)     throw new RuntimeException();
    int oldLimit=inBuffer.limit();
    inBuffer.limit(inBuffer.position() + 128);
    int cipherReadSize=cipher.doFinal(inBuffer,cipherBuffer);
    inBuffer.limit(oldLimit);
    cipherBuffer.flip();
    while (cipherBuffer.hasRemaining()) {
      if (packet == null) {
        packet=obtainReadable();
      }
      boolean complete=false;
      complete=packet.read(cipherBuffer);
      if (complete) {
        enqueueFullPacket(packet);
        packet=null;
      }
    }
    cipherBuffer.clear();
  }
}
