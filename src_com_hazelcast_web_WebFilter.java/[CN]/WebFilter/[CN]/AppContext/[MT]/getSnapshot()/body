{
  Snapshot s=snapshot.get();
  if (s.invalid()) {
    if (DEBUG) {
      log("Snapshot is not valid");
    }
synchronized (Snapshot.class) {
      s=snapshot.get();
      if (s.invalid()) {
        final Snapshot sNew=new Snapshot(this,snapshotLifeTime);
        final boolean ok=snapshot.compareAndSet(s,sNew);
        if (ok) {
          fireSnapshotEvent(s.createSnapshotEvent());
          return sNew;
        }
 else         return snapshot.get();
      }
    }
  }
  return s;
}
